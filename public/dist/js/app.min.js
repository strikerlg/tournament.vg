(function() {
    'use strict';

    angular
        .module('vg.app', [
            /* Angular modules */
            'ngAnimate',
            /* App modules */
            /* Third-party modules */
            'ui.router',
            'firebase',
            'validation.match',
            'ordinal',
            'ngFileUpload',
            'ngImgur'
        ]);
})();;(function() {
	'use strict';

	angular
		.module('vg.app')
		.constant('FIREBASEDATA', {
			'FBURL': 'https://wolfscontests.firebaseio.com'
		})
		.config(config);

	/* @ngInject */
	function config($stateProvider, $urlRouterProvider) {

		// Redirect any unmatched URL to /.
		$urlRouterProvider.otherwise('/');

		$stateProvider
		    .state('home', {
		    	url: '/',
		    	templateUrl: 'app/home/home.htm',
		    	controller: 'HomeController as home'
		    })

		    .state('registerOrLogin', {
		    	url: '/registerOrLogin',
		    	templateUrl: '/app/home/reg.htm',
		    	controller: 'RegController as reg'
		    })

		    .state('profile', {
		    	url: '/profile/:username',
		    	templateUrl: '/app/home/profile.htm',
		    	controller: 'ProfileController as profile'
		    })

		    .state('leaderboard', {
		    	url: '/leaderboard',
		    	templateUrl: '/app/home/leaderboard.htm',
		    	controller: 'LeaderboardController as leaderboard'
		    })

		    .state('event', {
		    	url: '/event/:eventName/main',
		    	templateUrl: '/app/event/main.htm',
		    	controller: 'EventMainController as event'
		    })

		    .state('customizeAvatar', {
		    	url: '/customizeAvatar',
		    	templateUrl: '/app/home/avatar.htm',
		    	controller: 'AvatarController as avatar',

		    	resolve: {
		    		'currentAuth': ['AuthWrapper', function(AuthWrapper) {
		    			return AuthWrapper.$requireAuth();
		    		}]
		    	}
		    })

		    .state('changePassword', {
		    	url: '/changePassword',
		    	templateUrl: '/app/home/changePassword.htm',
		    	controller: 'ChangePasswordController as pwchange',

		    	resolve: {
		    		'currentAuth': ['AuthWrapper', function(AuthWrapper) {
		    			return AuthWrapper.$requireAuth();
		    		}]
		    	}
		    });
	}
	config.$inject = ["$stateProvider", "$urlRouterProvider"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .run(run);

    function run($rootScope, $location, $state, $firebaseObject, AuthWrapper, FIREBASEDATA) {

        $rootScope.$on('$stateChangeError', function(event, toState, toParams, fromState, fromParams, error) {
            if (error === 'AUTH_REQUIRED') {
                $state.go('registerOrLogin');
            }
        });

        $rootScope.$on('$stateChangeSuccess', function() {

            // If user is logged in, download their profile data to an object in $rootScope.
            // FIXME: We shouldn't need to do this every successful state change.
            if (AuthWrapper.$getAuth()) {
                
                var authData = AuthWrapper.$getAuth();
                var ref = new Firebase(FIREBASEDATA.FBURL);

                var profileData = $firebaseObject(ref.child('users').child(authData.uid));
                profileData.$bindTo($rootScope, 'profile').then(function(unbind) {
                    $rootScope.unbindFunction = unbind;
                });

            }

        });

    }
    run.$inject = ["$rootScope", "$location", "$state", "$firebaseObject", "AuthWrapper", "FIREBASEDATA"];

})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .service('authService', authService);

    /* @ngInject */
    function authService($q, $rootScope, $state, $window, $timeout, $firebaseObject, AuthWrapper, FIREBASEDATA) {
        
        this.testData = 'hello world!';

    	this.checkIfUserExists = checkIfUserExists;
    	this.createNewUser = createNewUser;
        this.loginToAccount = loginToAccount;
        this.logOut = logOut;

    	///////////////////

    	function checkIfUserExists(inputUsername) {

    		var deferred = $q.defer();

    		var doesUserExist = false;
    		var usersRef = new $window.Firebase(FIREBASEDATA.FBURL + '/users');

    		usersRef.once('value', function(dataSnapshot) {

                $timeout(function() {
                    dataSnapshot.forEach(function(user) {
                        if (user.val().userName === inputUsername) {
                            doesUserExist = true;
                        }
                    });

                    deferred.resolve(doesUserExist);
                });

    		});

    		return deferred.promise;

    	}

    	function createNewUser(inputEmail, inputPassword, inputUsername) {

            var deferred = $q.defer();

    		AuthWrapper.$createUser({
    			email: inputEmail,
    			password: inputPassword
    		}).then(function(userData) {

    			// Create a data entry for the new username.
    			new Firebase(FIREBASEDATA.FBURL).child('users/' + userData.uid).set({

    				userName: inputUsername,
    				role: 'User'

    			}, function(errorData) {
    				console.error(errorData);
                    return errorData.code;
    			});

                // Create a data entry for the user's avatar.
                new Firebase(FIREBASEDATA.FBURL).child('avatars').child(inputUsername).set('http://api.adorable.io/avatars/42/' + inputUsername);

    			// Log the user in.
    			AuthWrapper.$authWithPassword({
    				email: inputEmail,
    				password: inputPassword
    			}).then(function() {
                    deferred.resolve('ACCOUNT_CREATED');
                });

    		}).catch(function(errorData) {

    			console.error(errorData);

    			if (errorData.code === 'EMAIL_TAKEN') {
                    deferred.resolve(errorData.code);
    			}

    		});

            return deferred.promise;

    	}

        function loginToAccount(inputEmail, inputPassword) {

            var deferred = $q.defer();

            AuthWrapper.$authWithPassword({
                email: inputEmail,
                password: inputPassword
            }).then(function(authData) {

                deferred.resolve('LOGIN_SUCCESS');

            }).catch(function(errorData) {

                if (errorData.code === 'INVALID_USER') {
                    deferred.resolve('INVALID_USER');
                } else if (errorData.code === 'INVALID_PASSWORD') {
                    deferred.resolve('INVALID_PASSWORD');
                }

            });

            return deferred.promise;

        }

        function logOut() {
            AuthWrapper.$unauth();
            $rootScope.unbindFunction();
        }

    }
    authService.$inject = ["$q", "$rootScope", "$state", "$window", "$timeout", "$firebaseObject", "AuthWrapper", "FIREBASEDATA"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .factory('AuthWrapper', AuthWrapper);

    /* @ngInject */
    function AuthWrapper($firebaseAuth, FIREBASEDATA) {

        var ref = new Firebase(FIREBASEDATA.FBURL);
        return $firebaseAuth(ref);

    }
    AuthWrapper.$inject = ["$firebaseAuth", "FIREBASEDATA"];
    
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .directive('vgGamesList', vgGamesList);

    /* @ngInject */
    function vgGamesList () {
        var directive = {
            bindToController: true,
            controller: GamesListController,
            controllerAs: 'vm',
            restrict: 'E',
            templateUrl: './app/eventComponents/gamesList.directive.htm',
            scope: false,
            transclude: false
        };
        return directive;
    }

    /* @ngInject */
    function GamesListController($scope, eventService) {
        /* jshint validthis: true */
    	var vm = this;

        $scope.$watch(function() { return eventService.getGameListObject(); }, function(model) {
            $scope.$parent.$parent.event.gameList = model;
        }, true);
    }
    GamesListController.$inject = ["$scope", "eventService"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .directive('vgMultiGameLeaderboard', vgMultiGameLeaderboard);

    /* @ngInject */
    function vgMultiGameLeaderboard () {
        var directive = {
            bindToController: true,
            controller: MultiGameLeaderboardController,
            controllerAs: 'vm',
            restrict: 'E',
            templateUrl: './app/eventComponents/multiGameLeaderboard.directive.htm',
            scope: false,
            transclude: false
        };
        return directive;
    }

    /* @ngInject */
    function MultiGameLeaderboardController($scope, eventService) {
        /* jshint validthis: true */
    	var vm = this;

        $scope.$watch(function() { return eventService.getLeaderboardLengthValue(); }, function(model) {
            $scope.$parent.$parent.event.leaderboardLength = model;
        }, true);

        $scope.$watch(function() { return eventService.getSummarizedLeaderboardObject(); }, function(model) {
            $scope.$parent.$parent.event.summarizedLeaderboard = model;
        }, true);
    }
    MultiGameLeaderboardController.$inject = ["$scope", "eventService"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .directive('vgSingleGameLeaderboard', vgSingleGameLeaderboard);

    /* @ngInject */
    function vgSingleGameLeaderboard () {
        var directive = {
            bindToController: true,
            controller: SingleGameLeaderboardController,
            controllerAs: 'vm',
            restrict: 'E',
            templateUrl: './app/eventComponents/singleGameLeaderboard.directive.htm',
            scope: false,
            transclude: false
        };
        return directive;
    }

    /* @ngInject */
    function SingleGameLeaderboardController($scope, eventService) {
        /* jshint validthis: true */
    	var vm = this;

        $scope.$watch(function() { return eventService.getLeaderboardLengthValue(); }, function(model) {
            $scope.$parent.$parent.event.leaderboardLength = model;
        }, true);

        $scope.$watch(function() { return eventService.getSummarizedLeaderboardObject(); }, function(model) {
            $scope.$parent.$parent.event.summarizedLeaderboard = model;
        }, true);
    }
    SingleGameLeaderboardController.$inject = ["$scope", "eventService"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .directive('vgStickyMessage', vgStickyMessage);

    /* @ngInject */
    function vgStickyMessage () {
        var directive = {
            bindToController: true,
            controller: StickyMessageController,
            controllerAs: 'vm',
            restrict: 'E',
            templateUrl: './app/eventComponents/stickyMessage.directive.htm',
            scope: {
            	properties: '='
            }
        };
        return directive;
    }

    /* @ngInject */
    function StickyMessageController($timeout) {
        /* jshint validthis: true */
    	var vm = this;
    }
    StickyMessageController.$inject = ["$timeout"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .service('eventService', eventService);

    /* @ngInject */
    function eventService($q, $filter, $firebaseObject, $firebaseArray, FIREBASEDATA) {

        var _eventProperties = null;
        var _gameList = null;
        var _leaderboardLength = null;
        var _summarizedLeaderboard = null;
        var _teamList = null;

        this.createMultiGameFinalStandings = createMultiGameFinalStandings;
        this.getEventProperties = getEventProperties;
        this.getEventPropertiesObject = getEventPropertiesObject;
        this.getGameData = getGameData;
        this.getGameListObject = getGameListObject;
        this.getGamesList = getGamesList;
        this.getLeaderboardLengthValue = getLeaderboardLengthValue;
        this.getMultiGameLeaderboard = getMultiGameLeaderboard;
        this.getPlayerScores = getPlayerScores;
        this.getSingleGameLeaderboard = getSingleGameLeaderboard;
        this.getSummarizedLeaderboardObject = getSummarizedLeaderboardObject;
        this.getTeamListObject = getTeamListObject;
        this.loadEventProperties = loadEventProperties;

        ////////////////

        function createMultiGameFinalStandings(inputEvent) {

            // Calculate the final standings of the event.
            getMultiGameLeaderboard(inputEvent).then(function then(model) {

                var ref = new Firebase(FIREBASEDATA.FBURL);
                var inputEventStandings = $firebaseObject(
                    ref
                        .child('standings')
                        .child(inputEvent)
                );

                inputEventStandings.$loaded().then(function() {

                    model.forEach(function(standing) {
                        inputEventStandings[standing.key] = standing.position;
                    });

                    inputEventStandings.$save();

                });

            });

        }

        function getEventProperties(inputEvent) {

            var deferred = $q.defer();

        	var ref = new Firebase(FIREBASEDATA.FBURL);
        	var eventProperties = $firebaseObject(
        		ref
        			.child('contests')
        			.child(inputEvent)
        			.child('properties')
        	);

            deferred.resolve(eventProperties);

        	return deferred.promise;

        }

        function getEventPropertiesObject() {
            return _eventProperties;
        }

        function getFirstPlaceScores() {

            _gameList.forEach(function(game) {

                // If there are scores, get the top one.
                if (game.scores) {

                    var scoresArray = $.map(game.scores, function(el) { return el; });
                    scoresArray = $filter('orderBy')(scoresArray, '-score');
                    game.firstScore = scoresArray[0];

                }

            });

        }

        function getGameData(inputEvent, inputGame) {

            var deferred = $q.defer();

            var ref = new Firebase(FIREBASEDATA.FBURL);

            getGamesList(inputEvent).then(function(gamesList) {

                gamesList.forEach(function(game) {

                    if (game.camelName === inputGame) {
                        deferred.resolve(game);
                    }

                });

            });

            return deferred.promise;

        }

        function getGameListObject() {
            return _gameList;
        }

        function getGamesList(inputEvent) {

        	var deferred = $q.defer();

        	var ref = new Firebase(FIREBASEDATA.FBURL);
        	var gamesList = $firebaseArray(
        		ref
        			.child('contests')
        			.child(inputEvent)
        			.child('activeGames')
        	);

        	gamesList.$loaded().then(function() {
        		deferred.resolve(gamesList);
        	});

        	return deferred.promise;

        }

        function getLeaderboardLengthValue() {
            return _leaderboardLength;
        }

        function getMultiGameLeaderboard(inputEvent) {

        	var deferred = $q.defer();

        	// We need to get the top 12 players for every game.
        	var playerPoints = {};

        	getGamesList(inputEvent).then(function then(model) {

        		var gamesList = model;
        		gamesList.forEach(function(game) {

        			if (game.scores) {

        				// Convert the game's scores to an array.
        				var scoresArray = $.map(game.scores, function(el) { return el; });
        				scoresArray = $filter('orderBy')(scoresArray, '-score');

        				var totalAward = 12;

        				// Iterate through the top scores awarding points.
        				for (var i = 0; i < scoresArray.length; i++) {

        					if (!playerPoints[scoresArray[i].userName]) {
        						playerPoints[scoresArray[i].userName] = {
        							points: 0
        						};
        					}

        					playerPoints[scoresArray[i].userName].points += totalAward;

        					if (totalAward > 0) {
        						totalAward -= 1;
        					}

        				}

        			}

        		});

        		// Find and resolve ties.
        		playerPoints = $filter('orderObjectBy')(playerPoints, 'points', true);
                var haveBottomScorersFloor = false;
                var floorRange = 0;
        		for (var i = 0; i < playerPoints.length; i += 1) {

        			if (playerPoints[i-1] && playerPoints[i].points && playerPoints[i-1].points) {

        				if (playerPoints[i].points === playerPoints[i-1].points) {
        					playerPoints[i].position = playerPoints[i-1].position;
        				} else {
        					playerPoints[i].position = (i+1);
        				}

        			} else {

        				if (i === 0) {
        					playerPoints[i].position = 1;
        				} else {

                            if (!haveBottomScorersFloor) {
                                // Get count of players in one position higher.
                                var getScoreCountOf = playerPoints[i-1].points;

                                for (var j = 0; j < playerPoints.length; j += 1) {
                                    if (playerPoints[j].points === getScoreCountOf) {
                                        floorRange += 1;
                                    }
                                }

                                haveBottomScorersFloor = true;
                            }

        					playerPoints[i].position = (playerPoints.length + 1) - floorRange;
        				}

        			}

        		}

        		deferred.resolve(playerPoints);

        	});

			return deferred.promise;

        }

        function getSingleGameLeaderboard(inputEvent) {

            var deferred = $q.defer();

            var ref = new Firebase(FIREBASEDATA.FBURL);
            var leaderboardData = $firebaseArray(
                ref
                    .child('contests')
                    .child(inputEvent)
                    .child('scores')
            );

            deferred.resolve(leaderboardData);

            return deferred.promise;

        }

        function getSummarizedLeaderboardObject() {
            return _summarizedLeaderboard;
        }

        function getTeamListObject() {
            return _teamList;
        }

        function getPlayerScores(inputEvent, inputGamesList, inputPlayer) {

            var deferred = $q.defer();

            var displayScores = [];

            // Iterate through every game.
            inputGamesList.forEach(function(game) {

                if (game.scores) {

                    // Convert the game's scores to an array.
                    var scoresArray = $.map(game.scores, function(el) { return el; });
                    scoresArray = $filter('orderBy')(scoresArray, '-score');

                    var totalAward = 12;

                    // Iterate through the scores starting from the top and find our user.
                    for (var i = 0; i < scoresArray.length; i++) {

                        // Found our player.
                        if (scoresArray[i].userName === inputPlayer) {

                            var newScoreObject = game;
                            newScoreObject.position = i+1;
                            newScoreObject.score = scoresArray[i].score;
                            newScoreObject.pointsEarned = totalAward;
                            newScoreObject.inpUrl = scoresArray[i].inpUrl ? scoresArray[i].inpUrl : null;
                            newScoreObject.twitchUrl = scoresArray[i].twitchUrl ? scoresArray[i].twitchUrl : null;
                            newScoreObject.mameVersion = scoresArray[i].mameVersion ? scoresArray[i].mameVersion : null;

                            displayScores.push(newScoreObject);
                            totalAward = 12;
                            break;

                        } else {
                            if (totalAward > 0) {
                                totalAward -= 1;
                            }
                        }

                    }

                }

            });

            deferred.resolve(displayScores);

            return deferred.promise;

        }

        function loadEventProperties(inputEvent) {

            var ref = new Firebase(FIREBASEDATA.FBURL);
            var inputEventProperties = $firebaseObject(
                ref
                    .child('contests')
                    .child(inputEvent)
                    .child('properties')
            );

            inputEventProperties.$loaded().then(function() {
                _eventProperties = inputEventProperties;

                // If this is a multigame event, get the data needed for multigame components.
                if (_eventProperties.format.multiGame) {

                    getGamesList(inputEvent).then(function then(model) {
                        _gameList = model;
                        getFirstPlaceScores();
                    });

                    getMultiGameLeaderboard(inputEvent).then(function then(model) {
                        var leaderboard = model;
                        _leaderboardLength = leaderboard.length;
                        _summarizedLeaderboard = leaderboard.slice(0, 8);
                    });

                // If this is a single game event, get the data needed for single game components.
                } else {

                    getSingleGameLeaderboard(inputEvent).then(function then(model) {
                        var leaderboard = model;
                        _leaderboardLength = leaderboard.length;
                        _summarizedLeaderboard = leaderboard;
                    });

                }

                // If this is a team-based event, get the data needed for team event components.
                if (_eventProperties.format.teamBased) {

                    teamService.getTeamList(vm.eventName).then(function then(model) {
                        _teamList = model;
                    });

                }

            });

        }

    }
    eventService.$inject = ["$q", "$filter", "$firebaseObject", "$firebaseArray", "FIREBASEDATA"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .controller('EventMainController', EventMainController);

    /* @ngInject */
    function EventMainController($scope, $filter, $stateParams, $state, $timeout, $firebaseArray, eventService, authService, profileService, teamService, FIREBASEDATA) {

        /* jshint validthis: true */
        var vm = this;

        vm.eventName = $stateParams.eventName;

        vm.createTeam = createTeam;
        vm.determinePoints = determinePoints;
        vm.goToPlayerProfile = goToPlayerProfile;
        vm.openGameModal = openGameModal;
        vm.openModal = openModal;
        vm.openMultiGameLeaderboardModal = openMultiGameLeaderboardModal;
        vm.openPlayerModal = openPlayerModal;

        initEvent();

        /////////////////////////////////

        function closeModal() {
            angular.element('.modal').closeModal();
        }

        function createTeam() {
            teamService.createTeam(vm.eventName, vm.newTeam).then(function() {
                Materialize.toast('Team ' + vm.newTeam.shortName + ' created.', 4000);
                vm.newTeam = null;
            });
        }

        function determinePoints(inputScoreData, inputIndex) {

            var userGamePoints;

            // No position greater than 12 gets points.
            if (inputIndex > 11) {
                userGamePoints = 0;
                return userGamePoints;
            }

            userGamePoints = 12 - inputIndex;

            var sortedScores = $filter('orderBy')(vm.gameScores, '-score');

            // Am I tied with the person above me? If so, match their points.
            if (sortedScores[inputIndex - 1]) {

                if (sortedScores[inputIndex - 1].score === inputScoreData.score) {
                    userGamePoints += 1;
                }
            }

            return userGamePoints;

        }

        function goToPlayerProfile(inputPlayer) {

            closeModal();
            $state.go('profile', {username: inputPlayer});

        }

        function initEvent() {

            eventService.loadEventProperties(vm.eventName);

            profileService.getAvatarData().then(function then(model) {
                vm.avatarData = model;
            });

            $scope.$watch(function() { return eventService.getEventPropertiesObject(); }, function(model) {
                vm.eventProperties = model;
            }, true);

            $scope.$watch(function() { return eventService.getTeamListObject(); }, function(model) {
                vm.teamList = model;
            }, true);

        }

        function openModal(inputModal) {

            // This will evaluate to true if a Materialize modal is open.
            if (angular.element('#lean-overlay').length === 1) {

                closeModal();
                $timeout(function() {
                    angular.element(inputModal).openModal();
                    angular.element(inputModal + 'Content').scrollTop(0);
                }, 450);

            } else {

                angular.element(inputModal).openModal();
                angular.element(inputModal + 'Content').scrollTop(0);

            }

        }

        function openGameModal(inputGameName) {

            var ref = new Firebase(FIREBASEDATA.FBURL);

            eventService.getGameData(vm.eventName, inputGameName).then(function then(model) {
                vm.gameData = model;

                vm.gameScores = $firebaseArray(
                    ref
                        .child('contests')
                        .child(vm.eventName)
                        .child('activeGames')
                        .child(vm.gameData.$id)
                        .child('scores')
                );
            });

            openModal('#gameModal');

        }

        function openMultiGameLeaderboardModal() {

            eventService.getMultiGameLeaderboard(vm.eventName).then(function then(model) {
                vm.completeLeaderboard = model;
            });

            openModal('#multiGameLeaderboardModal');

        }

        function openPlayerModal(inputPlayer) {

            vm.focusPlayer = inputPlayer;

            eventService.getPlayerScores(vm.eventName, vm.gameList, vm.focusPlayer).then(function then(model) {
                vm.playerScores = model;
            });

            openModal('#playerModal');

        }

    }
    EventMainController.$inject = ["$scope", "$filter", "$stateParams", "$state", "$timeout", "$firebaseArray", "eventService", "authService", "profileService", "teamService", "FIREBASEDATA"];

})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .service('teamService', teamService);

    /* @ngInject */
    function teamService($q, $firebaseArray, $firebaseObject, FIREBASEDATA) {

    	this.createTeam = createTeam;
        this.getTeamList = getTeamList;

        ////////////////

        function createTeam(inputEvent, inputNewTeamProperties) {

        	var deferred = $q.defer();

        	var ref = new Firebase(FIREBASEDATA.FBURL);
        	var teamPool = $firebaseObject(
        		ref
        			.child('contests')
        			.child(inputEvent)
        			.child('teamPool')
        	);

        	teamPool.$loaded().then(function() {

        		teamPool[inputNewTeamProperties.shortName] = {
        			fullName: inputNewTeamProperties.formalName
        		};
        		teamPool.$save();
        		deferred.resolve();

        	});

        	return deferred.promise;

        }

        function getTeamList(inputEvent) {

        	var deferred = $q.defer();

        	var ref = new Firebase(FIREBASEDATA.FBURL);
        	var teamList = $firebaseArray(
        		ref
        			.child('contests')
        			.child(inputEvent)
        			.child('teamPool')
        	);

        	teamList.$loaded().then(function() {
        		deferred.resolve(teamList);
        	});

        	return deferred.promise;

        }
    }
    teamService.$inject = ["$q", "$firebaseArray", "$firebaseObject", "FIREBASEDATA"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .filter('orderObjectBy', orderObjectBy);

    function orderObjectBy() {
        return function(items, field, reverse) {
            var filtered = [];

            angular.forEach(items, function(item, key) {
                item.key = key;
                filtered.push(item);
            });

            filtered.sort(function (a, b) {
                return (a[field] > b[field] ? 1 : -1);
            });

            if(reverse) filtered.reverse();

            return filtered;
        };
    }

})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .controller('HeaderController', HeaderController);

    /* @ngInject */
    function HeaderController($timeout, $rootScope, $window, $state, authService) {

        /* jshint validthis: true */
        var vm = this;
        vm.logOut = logOut;

        activate();

        //////////////////////////

        function activate() {
            $timeout(function() {
                angular.element('.dropdown-button')
                    .dropdown({
                        inDuration: 300,
                        outDuration: 225,
                        constrain_width: false,
                        hover: false,
                        gutter: -114,
                        belowOrigin: true
                    });
            }, 400);
        }

        function logOut() {
            authService.logOut();
            $window.location.reload();
        }

    }
    HeaderController.$inject = ["$timeout", "$rootScope", "$window", "$state", "authService"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .controller('AvatarController', AvatarController);

    /* @ngInject */
    function AvatarController($rootScope, $state, $stateParams, $timeout, Upload, imgur, profileService) {

        /* jshint validthis: true */
        var vm = this;
        vm.uploadAvatar = uploadAvatar;

        activate();

        ////////////////

        function activate() {
        	profileService.getAvatarData().then(function then(model) {
                vm.avatarData = model;
            });

            // FIXME: This needs to be triggered by a $rootScope broadcast of when it receives profile data.
            $timeout(function() {
                profileService.getBadgesData($rootScope.profile.userName).then(function then(model) {
                    vm.badgesData = model;
                });
            }, 500);
        }

        function uploadAvatar() {

        	vm.disableButton = true;

        	imgur.setAPIKey('Client-ID f53d6d5833b07bc');
        	imgur.upload(vm.file).then(function then(model) {
        		profileService.saveAvatarLink(model[0].link, $rootScope.profile.userName);
        		Materialize.toast('Your avatar was uploaded', 4000);

        		$timeout(function() {
        			$state.go('home');
        		}, 1000);
        	});

        }

    }
    AvatarController.$inject = ["$rootScope", "$state", "$stateParams", "$timeout", "Upload", "imgur", "profileService"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .controller('ChangePasswordController', ChangePasswordController);

    /* @ngInject */
    function ChangePasswordController($scope, $timeout, $state, AuthWrapper) {

        /* jshint validthis: true */
        var vm = this;
        
        vm.submitChangePassword = submitChangePassword;

        //////////////////

        function submitChangePassword() {

            if ($scope.pwChangeForm.$valid) {

                AuthWrapper.$changePassword({
                    email: AuthWrapper.$getAuth().password.email,
                    oldPassword: vm.inputCurrentPassword,
                    newPassword: vm.inputNewPassword
                }).then(function() {

                    Materialize.toast('Your password was changed.', 4000);
                    $timeout(function() {
                        $state.go('home');
                    }, 1000);

                }).catch(function(error) {
                    
                    if (error.code === 'INVALID_PASSWORD') {
                        vm.showChangePasswordMessage = true;
                    }

                });

            }

        }

    }
    ChangePasswordController.$inject = ["$scope", "$timeout", "$state", "AuthWrapper"];

})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .controller('HomeController', HomeController);

    /* @ngInject */
    function HomeController($scope, $timeout) {

        /* jshint validthis: true */
        var vm = this;

        ////////////////////////

    }
    HomeController.$inject = ["$scope", "$timeout"];

})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .controller('LeaderboardController', LeaderboardController);

    /* @ngInject */
    function LeaderboardController($q, $timeout, $firebaseArray, profileService, FIREBASEDATA) {

        /* jshint validthis: true */
    	var vm = this;

        activate();

        ////////////////

        function activate() {
            getProfileScores().then(function then(model) {
                vm.profileScoreData = model;
            });

            profileService.getAvatarData().then(function then(model) {
                vm.avatarData = model;
            });
        }

        function getProfileScores() {

        	var deferred = $q.defer();
        	var ref = new Firebase(FIREBASEDATA.FBURL);

        	var profileScoreData = $firebaseArray(
        		ref
        			.child('badges')
        	);

        	profileScoreData.$loaded(function() {
        		deferred.resolve(profileScoreData);
        	});

        	return deferred.promise;

        }

    }
    LeaderboardController.$inject = ["$q", "$timeout", "$firebaseArray", "profileService", "FIREBASEDATA"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .controller('ProfileController', ProfileController);

    /* @ngInject */
    function ProfileController($scope, $stateParams, $q, $timeout, $state, $firebaseArray, authService, profileService, eventService) {

        /* jshint validthis: true */
        var vm = this;
        
        activate();

        /////////////////////////////////

        function activate() {

            profileService.getUserData($stateParams.username).then(function then(model) {
                vm.profileData = model;

                profileService.getTournamentHistory(vm.profileData).then(function then(model) {
                    var tournamentHistoryData = model;
                    vm.eventStandings = profileService.getTournamentStandings(tournamentHistoryData, $stateParams.username);
                });
            });

            profileService.getAvatarData().then(function then(model) {
                vm.avatarData = model;
            });

            profileService.getBadgesData($stateParams.username).then(function then(model) {
                vm.badgesData = model;

                $timeout(function() {

                    angular.element('.collapsible').collapsible({
                        accordion: true
                    });

                }, 200);
            });

        }

    }
    ProfileController.$inject = ["$scope", "$stateParams", "$q", "$timeout", "$state", "$firebaseArray", "authService", "profileService", "eventService"];

})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .service('profileService', profileService);

    /* @ngInject */
    function profileService($rootScope, $q, $firebaseArray, $firebaseObject, eventService, FIREBASEDATA) {

    	this.getAvatarData = getAvatarData;
        this.getBadgesData = getBadgesData;
    	this.getTournamentHistory = getTournamentHistory;
        this.getTournamentStandings = getTournamentStandings;
        this.getUserData = getUserData;
        this.saveAvatarLink = saveAvatarLink;

        ////////////////

        function getAvatarData() {

            var deferred = $q.defer();
            var ref = new Firebase(FIREBASEDATA.FBURL);

            var avatarData = $firebaseObject(
                ref
                    .child('avatars')
            );

            avatarData.$loaded(function() {
                deferred.resolve(avatarData);
            });

            return deferred.promise;

        }

        function getBadgesData(inputUser) {

            var deferred = $q.defer();
            var ref = new Firebase(FIREBASEDATA.FBURL);

            var badgesData = $firebaseObject(
                ref
                    .child('badges')
                    .child(inputUser)
            );

            badgesData.$loaded(function() {
                deferred.resolve(badgesData);
            });

            return deferred.promise;

        }

        function getTournamentHistory(inputUserData) {

        	var deferred = $q.defer();
        	var ref = new Firebase(FIREBASEDATA.FBURL);

        	// Loop through each event in the pledgedTo object.
        	var eventsArray = [];
        	for (var key in inputUserData.pledgedTo) {
        		eventsArray.push(key);
        	}

        	deferred.resolve(eventsArray);

        	return deferred.promise;

        }

        function getTournamentStandings(inputTournamentHistory, inputUser) {

            var ref = new Firebase(FIREBASEDATA.FBURL);

            // Loop through each event in the user's history.
            var eventStandings = [];
            inputTournamentHistory.forEach(function(event) {

                eventService.getEventProperties(event).then(function(eventProperties) {

                    eventProperties.$loaded().then(function() {

                        // If concluded, get the user's standing.
                        if (eventProperties.state === 'concluded') {

                            var eventStandingData = $firebaseObject(
                                ref
                                    .child('standings')
                                    .child(event)
                            );

                            eventStandingData.$loaded().then(function() {

                                if (eventStandingData[inputUser]) {

                                    eventStandings.push({
                                        name: eventProperties.name,
                                        premier: eventProperties.premier ? true : null,
                                        shortName: event,
                                        state: 'concluded',
                                        color: eventProperties.color,
                                        position: eventStandingData[inputUser]
                                    });

                                } else {

                                    eventStandings.push({
                                        name: eventProperties.name,
                                        premier: eventProperties.premier ? true : null,
                                        shortName: event,
                                        state: 'concluded',
                                        color: eventProperties.color,
                                        position: -1
                                    });

                                }

                            });

                        } else if (eventProperties.state === 'inprogress' || eventProperties.state === 'upcoming') {

                            eventStandings.push({
                                name: eventProperties.name,
                                premier: eventProperties.premier ? true : null,
                                shortName: event,
                                color: eventProperties.color,
                                state: eventProperties.state
                            });

                        }

                    });

                });

            });

            return eventStandings;

        }

        function getUserData(inputUser) {

        	var deferred = $q.defer();
        	var ref = new Firebase(FIREBASEDATA.FBURL);

        	var usersData = $firebaseArray(
        		ref
        			.child('users')
        	);

        	usersData.$loaded(function() {

        		usersData.forEach(function(user) {
        			if (user.userName === inputUser) {
        				deferred.resolve(user);
        			}
        		});

        	});

        	return deferred.promise;

        }

        // FIXME: Make this server-side.
        function saveAvatarLink(inputLink, inputUser) {
            
            var ref = new Firebase(FIREBASEDATA.FBURL);

            var avatarData = $firebaseObject(
                ref
                    .child('avatars')
            );

            avatarData.$loaded(function() {
                avatarData[inputUser] = inputLink;
                avatarData.$save();
            });

        }

    }
    profileService.$inject = ["$rootScope", "$q", "$firebaseArray", "$firebaseObject", "eventService", "FIREBASEDATA"];
})();;(function() {
    'use strict';

    angular
        .module('vg.app')
        .controller('RegController', RegController);

    /* @ngInject */
    function RegController($scope, $rootScope, $timeout, $window, $state, $firebaseObject, authService, AuthWrapper) {

        /* jshint validthis: true */
        var vm = this;

        vm.loginToAccount = loginToAccount;
        vm.passwordReset = passwordReset;
        vm.submitNewAccount = submitNewAccount;

        /////////////////////

        function loginToAccount() {

            authService.loginToAccount(vm.loginEmail, vm.loginPassword).then(function then(model) {

                vm.showInvalidUserError = false;
                vm.showInvalidPasswordError = false;

                if (model === 'LOGIN_SUCCESS') {

                    $state.go('home');

                } else if (model === 'INVALID_USER') {
                    vm.showInvalidUserError = true;
                    return;
                } else if (model === 'INVALID_PASSWORD') {
                    vm.showInvalidPasswordError = true;
                }

            });

        }

        function passwordReset() {

            if (!vm.loginEmail) {
                vm.showPasswordResetEmailMessage = true;
                return;
            }

            AuthWrapper.$resetPassword({
                email: vm.loginEmail
            }).then(function() {
                vm.showPasswordResetEmailMessage = false;
                Materialize.toast('A password reset email has been sent to ' + vm.loginEmail + '.', 4000);
            });

        }

        function submitNewAccount() {
            
            // Does the user exist? If so, show an error message.
            authService.checkIfUserExists(vm.newUsername).then(function(userExists) {

                vm.showDuplicateUserError = false;
                vm.showEmailTakenError = false;

                if (userExists) {

                    vm.showDuplicateUserError = true;
                    return;

                // Try to create the new user.
                } else {

                    authService.createNewUser(vm.newEmail, vm.newPassword, vm.newUsername).then(function then(model) {

                        if (model === 'EMAIL_TAKEN') {

                            vm.showEmailTakenError = true;
                            return;

                        } else if (model === 'ACCOUNT_CREATED') {

                            $state.go('profile', {username: vm.newUsername});

                        }

                    });

                }

            });

        }

    }
    RegController.$inject = ["$scope", "$rootScope", "$timeout", "$window", "$state", "$firebaseObject", "authService", "AuthWrapper"];

})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5tb2R1bGUuanMiLCJhcHAuY29uZmlnLmpzIiwiYXBwLnJ1bi5qcyIsImF1dGgvYXV0aC5zZXJ2aWNlLmpzIiwiYXV0aC9hdXRod3JhcHBlci5mYWN0b3J5LmpzIiwiZXZlbnRDb21wb25lbnRzL2dhbWVzTGlzdC5kaXJlY3RpdmUuanMiLCJldmVudENvbXBvbmVudHMvbXVsdGlHYW1lTGVhZGVyYm9hcmQuZGlyZWN0aXZlLmpzIiwiZXZlbnRDb21wb25lbnRzL3NpbmdsZUdhbWVMZWFkZXJib2FyZC5kaXJlY3RpdmUuanMiLCJldmVudENvbXBvbmVudHMvc3RpY2t5TWVzc2FnZS5kaXJlY3RpdmUuanMiLCJldmVudC9ldmVudC5zZXJ2aWNlLmpzIiwiZXZlbnQvbWFpbi5jb250cm9sbGVyLmpzIiwiZXZlbnQvdGVhbS5zZXJ2aWNlLmpzIiwiaGVscGVycy9vcmRlck9iamVjdEJ5LmZpbHRlci5qcyIsImhlYWRlci9oZWFkZXIuY29udHJvbGxlci5qcyIsImhvbWUvYXZhdGFyLmNvbnRyb2xsZXIuanMiLCJob21lL2NoYW5nZVBhc3N3b3JkLmNvbnRyb2xsZXIuanMiLCJob21lL2hvbWUuY29udHJvbGxlci5qcyIsImhvbWUvbGVhZGVyYm9hcmQuY29udHJvbGxlci5qcyIsImhvbWUvcHJvZmlsZS5jb250cm9sbGVyLmpzIiwiaG9tZS9wcm9maWxlLnNlcnZpY2UuanMiLCJob21lL3JlZy5jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLENBQUEsV0FBQTtJQUNBOztJQUVBO1NBQ0EsT0FBQSxVQUFBOztZQUVBOzs7WUFHQTtZQUNBO1lBQ0E7WUFDQTtZQUNBO1lBQ0E7O0tBRUEsQ0NoQkEsQ0FBQSxXQUFBO0NBQ0E7O0NBRUE7R0FDQSxPQUFBO0dBQ0EsU0FBQSxnQkFBQTtHQUNBLFNBQUE7O0dBRUEsT0FBQTs7O0NBR0EsU0FBQSxPQUFBLGdCQUFBLG9CQUFBOzs7RUFHQSxtQkFBQSxVQUFBOztFQUVBO09BQ0EsTUFB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QTs7Ozs7OztLQU1BLENDMUpBLENBQUEsV0FBQTtJQUNBOztJQUVBO1NBQ0EsT0FBQTtTQUNBLFFBQUEsZUFBQTs7O0lBR0EsU0FBQSxZQUFBLElBQUEsZ0JBQUEsaUJBQUEsY0FBQTs7S0FFQSxLQUFBLGFBQUE7UUFDQSxLQUFBLGNBQUE7Ozs7UUFJQSxTQUFBLFdBQUEsWUFBQSx3QkFBQTs7U0FFQSxJQUFBLFdBQUEsR0FBQTs7U0FFQSxJQUFBLE1BQUEsSUFBQSxTQUFBLGFBQUE7U0FDQSxJQUFBLFdBQUE7VUFDQTtZQUNBLE1BQUE7WUFDQSxNQUFBO1lBQ0EsTUFBQTs7O1NBR0EsU0FBQSxVQUFBLEtBQUEsV0FBQTs7VUFFQSxTQUFBLHVCQUFBLGFBQUE7V0FDQSxVQUFBLHVCQUFBOztVQUVBLFNBQUE7VUFDQSxTQUFBOzs7O1NBSUEsT0FBQSxTQUFBOzs7O1FBSUEsU0FBQSxZQUFBLFlBQUE7O1NBRUEsSUFBQSxXQUFBLEdBQUE7O1NBRUEsSUFBQSxNQUFBLElBQUEsU0FBQSxhQUFBO1NBQ0EsSUFBQSxXQUFBO1VBQ0E7WUFDQSxNQUFBO1lBQ0EsTUFBQTtZQUNBLE1BQUE7OztTQUdBLFNBQUEsVUFBQSxLQUFBLFdBQUE7VUFDQSxTQUFBLFFBQUE7OztTQUdBLE9BQUEsU0FBQTs7Ozs7S0FJQSxDQzdEQSxDQUFBLFdBQUE7SUFDQTs7SUFFQTtTQUNBLE9BQUE7U0FDQSxPQUFBLGlCQUFBOztJQUVBLFNBQUEsZ0JBQUE7UUFDQSxPQUFBLFNBQUEsT0FBQSxPQUFBLFNBQUE7WUFDQSxJQUFBLFdBQUE7O1lBRUEsUUFBQSxRQUFBLE9BQUEsU0FBQSxNQUFBLEtBQUE7Z0JBQ0EsS0FBQSxNQUFBO2dCQUNBLFNBQUEsS0FBQTs7O1lBR0EsU0FBQSxLQUFBLFVBQUEsR0FBQSxHQUFBO2dCQUNBLFFBQUEsRUFBQSxTQUFBLEVBQUEsU0FBQSxJQUFBLENBQUE7OztZQUdBLEdBQUEsU0FBQSxTQUFBOztZQUVBLE9BQUE7Ozs7S0FJQSxDQzFCQSxDQUFBLFdBQUE7SUFDQTs7SUFFQTtTQUNBLE9BQUE7U0FD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QUdBLFlBQUEsZUFBQTtnQkFDQSxPQUFBLEdBQUE7ZUFDQSxLQUFBLFdBQUE7Z0JBQ0EsR0FBQSxnQ0FBQTtnQkFDQSxZQUFBLE1BQUEsNkNBQUEsR0FBQSxhQUFBLEtBQUE7Ozs7O1FBS0EsU0FBQSxtQkFBQTs7O1lBR0EsWUFBQSxrQkFBQSxHQUFBLGFBQUEsS0FBQSxTQUFBLFlBQUE7O2dCQUVBLEdBQUEseUJBQUE7Z0JBQ0EsR0FBQSxzQkFBQTs7Z0JBRUEsSUFBQSxZQUFBOztvQkFFQSxHQUFBLHlCQUFBO29CQUNBOzs7dUJBR0E7O29CQUVBLFlBQUEsY0FBQSxHQUFBLFVBQUEsR0FBQSxhQUFBLEdBQUEsYUFBQSxLQUFBLFNBQUEsS0FBQSxPQUFBOzt3QkFFQSxJQUFBLFVBQUEsZUFBQTs7NEJBRUEsR0FBQSxzQkFBQTs0QkFDQTs7K0JBRUEsSUFBQSxVQUFBLG1CQUFBOzs0QkFFQSxPQUFBLEdBQUEsV0FBQSxDQUFBLFVBQUEsR0FBQTs7Ozs7Ozs7Ozs7Ozs7O0tBY0EiLCJmaWxlIjoiYXBwLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbigpIHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICBhbmd1bGFyXG4gICAgICAgIC5tb2R1bGUoJ3ZnLmFwcCcsIFtcbiAgICAgICAgICAgIC8qIEFuZ3VsYXIgbW9kdWxlcyAqL1xuICAgICAgICAgICAgJ25nQW5pbWF0ZScsXG4gICAgICAgICAgICAvKiBBcHAgbW9kdWxlcyAqL1xuICAgICAgICAgICAgLyogVGhpcmQtcGFydHkgbW9kdWxlcyAqL1xuICAgICAgICAgICAgJ3VpLnJvdXRlcicsXG4gICAgICAgICAgICAnZmlyZWJhc2UnLFxuICAgICAgICAgICAgJ3ZhbGlkYXRpb24ubWF0Y2gnLFxuICAgICAgICAgICAgJ29yZGluYWwnLFxuICAgICAgICAgICAgJ25nRmlsZVVwbG9hZCcsXG4gICAgICAgICAgICAnbmdJbWd1cidcbiAgICAgICAgXSk7XG59KSgpOyIsIihmdW5jdGlvbigpIHtcblx0J3VzZSBzdHJpY3QnO1xuXG5cdGFuZ3VsYXJcblx0XHQubW9kdWxlKCd2Zy5hcHAnKVxuXHRcdC5jb25zdGFudCgnRklSRUJBU0VEQVRBJywge1xuXHRcdFx0J0ZCVVJMJzogJ2h0dHBzOi8vd29sZnNjb250ZXN0cy5maXJlYmFzZWlvLmNvbSdcblx0XHR9KVxuXHRcdC5jb25maWcoY29uZmlnKTtcblxuXHQvKiBAbmdJbmplY3QgKi9cblx0ZnVuY3Rpb24gY29uZmlnKCRzdGF0ZVByb3ZpZGVyLCAkdXJsUm91dGVyUHJvdmlkZXIpIHtcblxuXHRcdC8vIFJlZGlyZWN0IGFueSB1bm1hdGNoZWQgVVJMIHRvIC8uXG5cdFx0JHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSgnLycpO1xuXG5cdFx0JHN0YXRlUHJvdmlkZXJcblx0XHQgICAgLnN0YXRlKCdob21lJywge1xuXHRcdCAgICBcdHVybDogJy8nLFxuXHRcdCAgICBcdHRlbXBsYXRlVXJsOiAnYXBwL2hvbWUvaG9tZS5odG0nLFxuXHRcdCAgICBcdGNvbnRyb2xsZXI6ICdIb21lQ29udHJvbGxlciBhcyBob21lJ1xuXHRcdCAgICB9KVxuXG5cdFx0ICAgIC5zdGF0ZSgncmVnaXN0ZXJPckxvZ2luJywge1xuXHRcdCAgICBcdHVybDogJy9yZWdpc3Rlck9yTG9naW4nLFxuXHRcdCAgICBcdHRlbXBsYXRlVXJsOiAnL2FwcC9ob21lL3JlZy5odG0nLFxuXHRcdCAgICBcdGNvbnRyb2xsZXI6ICdSZWdDb250cm9sbGVyIGFzIHJlZydcblx0XHQgICAgfSlcblxuXHRcdCAgICAuc3RhdGUoJ3Byb2ZpbGUnLCB7XG5cdFx0ICAgIFx0dXJsOiAnL3Byb2ZpbGUvOnVzZXJuYW1lJyxcblx0XHQgICAgXHR0ZW1wbGF0ZVVybDogJy9hcHAvaG9tZS9wcm9maWxlLmh0bScsXG5cdFx0ICAgIFx0Y29udHJvbGxlcjogJ1Byb2ZpbGVDb250cm9sbGVyIGFzIHByb2ZpbGUnXG5cdFx0ICAgIH0pXG5cblx0XHQgICAgLnN0YXRlKCdsZWFkZXJib2FyZCcsIHtcblx0XHQgICAgXHR1cmw6ICcvbGVhZGVyYm9hcmQnLFxuXHRcdCAgICBcdHRlbXBsYXRlVXJsOiAnL2FwcC9ob21lL2xlYWRlcmJvYXJkLmh0bScsXG5cdFx0ICAgIFx0Y29udHJvbGxlcjogJ0xlYWRlcmJvYXJkQ29udHJvbGxlciBhcyBsZWFkZXJib2FyZCdcblx0XHQgICAgfSlcblxuXHRcdCAgICAuc3RhdGUoJ2V2ZW50Jywge1xuXHRcdCAgICBcdHVybDogJy9ldmVudC86ZXZlbnROYW1lL21haW4nLFxuXHRcdCAgICBcdHRlbXBsYXRlVXJsOiAnL2FwcC9ldmVudC9tYWluLmh0bScsXG5cdFx0ICAgIFx0Y29udHJvbGxlcjogJ0V2ZW50TWFpbkNvbnRyb2xsZXIgYXMgZXZlbnQnXG5cdFx0ICAgIH0pXG5cblx0XHQgICAgLnN0YXRlKCdjdXN0b21pemVBdmF0YXInLCB7XG5cdFx0ICAgIFx0dXJsOiAnL2N1c3RvbWl6ZUF2YXRhcicsXG5cdFx0ICAgIFx0dGVtcGxhdGVVcmw6ICcvYXBwL2hvbWUvYXZhdGFyLmh0bScsXG5cdFx0ICAgIFx0Y29udHJvbGxlcjogJ0F2YXRhckNvbnRyb2xsZXIgYXMgYXZhdGFyJyxcblxuXHRcdCAgICBcdHJlc29sdmU6IHtcblx0XHQgICAgXHRcdCdjdXJyZW50QXV0aCc6IFsnQXV0aFdyYXBwZXInLCBmdW5jdGlvbihBdXRoV3JhcHBlcikge1xuXHRcdCAgICBcdFx0XHRyZXR1cm4gQXV0aFdyYXBwZXIuJHJlcXVpcmVBdXRoKCk7XG5cdFx0ICAgIFx0XHR9XVxuXHRcdCAgICBcdH1cblx0XHQgICAgfSlcblxuXHRcdCAgICAuc3RhdGUoJ2NoYW5nZVBhc3N3b3JkJywge1xuXHRcdCAgICBcdHVybDogJy9jaGFuZ2VQYXNzd29yZCcsXG5cdFx0ICAgIFx0dGVtcGxhdGVVcmw6ICcvYXBwL2hvbWUvY2hhbmdlUGFzc3dvcmQuaHRtJyxcblx0XHQgICAgXHRjb250cm9sbGVyOiAnQ2hhbmdlUGFzc3dvcmRDb250cm9sbGVyIGFzIHB3Y2hhbmdlJyxcblxuXHRcdCAgICBcdHJlc29sdmU6IHtcblx0XHQgICAgXHRcdCdjdXJyZW50QXV0aCc6IFsnQXV0aFdyYXBwZXInLCBmdW5jdGlvbihBdXRoV3JhcHBlcikge1xuXHRcdCAgICBcdFx0XHRyZXR1cm4gQXV0aFdyYXBwZXIuJHJlcXVpcmVBdXRoKCk7XG5cdFx0ICAgIFx0XHR9XVxuXHRcdCAgICBcdH1cblx0XHQgICAgfSk7XG5cdH1cbn0pKCk7IiwiKGZ1bmN0aW9uKCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIGFuZ3VsYXJcbiAgICAgICAgLm1vZHVsZSgndmcuYXBwJylcbiAgICAgICAgLnJ1bihydW4pO1xuXG4gICAgZnVuY3Rpb24gcnVuKCRyb290U2NvcGUsICRsb2NhdGlvbiwgJHN0YXRlLCAkZmlyZWJhc2VPYmplY3QsIEF1dGhXcmFwcGVyLCBGSVJFQkFTRURBVEEpIHtcblxuICAgICAgICAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlRXJyb3InLCBmdW5jdGlvbihldmVudCwgdG9TdGF0ZSwgdG9QYXJhbXMsIGZyb21TdGF0ZSwgZnJvbVBhcmFtcywgZXJyb3IpIHtcbiAgICAgICAgICAgIGlmIChlcnJvciA9PT0gJ0FVVEhfUkVRVUlSRUQnKSB7XG4gICAgICAgICAgICAgICAgJHN0YXRlLmdvKCdyZWdpc3Rlck9yTG9naW4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN1Y2Nlc3MnLCBmdW5jdGlvbigpIHtcblxuICAgICAgICAgICAgLy8gSWYgdXNlciBpcyBsb2dnZWQgaW4sIGRvd25sb2FkIHRoZWlyIHByb2ZpbGUgZGF0YSB0byBhbiBvYmplY3QgaW4gJHJvb3RTY29wZS5cbiAgICAgICAgICAgIC8vIEZJWE1FOiBXZSBzaG91bGRuJ3QgbmVlZCB0byBkbyB0aGlzIGV2ZXJ5IHN1Y2Nlc3NmdWwgc3RhdGUgY2hhbmdlLlxuICAgICAgICAgICAgaWYgKEF1dGhXcmFwcGVyLiRnZXRBdXRoKCkpIHtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgYXV0aERhdGEgPSBBdXRoV3JhcHBlci4kZ2V0QXV0aCgpO1xuICAgICAgICAgICAgICAgIHZhciByZWYgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKTtcblxuICAgICAgICAgICAgICAgIHZhciBwcm9maWxlRGF0YSA9ICRmaXJlYmFzZU9iamVjdChyZWYuY2hpbGQoJ3VzZXJzJykuY2hpbGQoYXV0aERhdGEudWlkKSk7XG4gICAgICAgICAgICAgICAgcHJvZmlsZURhdGEuJGJpbmRUbygkcm9vdFNjb3BlLCAncHJvZmlsZScpLnRoZW4oZnVuY3Rpb24odW5iaW5kKSB7XG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUudW5iaW5kRnVuY3Rpb24gPSB1bmJpbmQ7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcblxuICAgIH1cblxufSkoKTsiLCIoZnVuY3Rpb24oKSB7XG4gICAgJ3VzZSBzdHJpY3QnO1xuXG4gICAgYW5ndWxhclxuICAgICAgICAubW9kdWxlKCd2Zy5hcHAnKVxuICAgICAgICAuc2VydmljZSgnYXV0aFNlcnZpY2UnLCBhdXRoU2VydmljZSk7XG5cbiAgICAvKiBAbmdJbmplY3QgKi9cbiAgICBmdW5jdGlvbiBhdXRoU2VydmljZSgkcSwgJHJvb3RTY29wZSwgJHN0YXRlLCAkd2luZG93LCAkdGltZW91dCwgJGZpcmViYXNlT2JqZWN0LCBBdXRoV3JhcHBlciwgRklSRUJBU0VEQVRBKSB7XG4gICAgICAgIFxuICAgICAgICB0aGlzLnRlc3REYXRhID0gJ2hlbGxvIHdvcmxkISc7XG5cbiAgICBcdHRoaXMuY2hlY2tJZlVzZXJFeGlzdHMgPSBjaGVja0lmVXNlckV4aXN0cztcbiAgICBcdHRoaXMuY3JlYXRlTmV3VXNlciA9IGNyZWF0ZU5ld1VzZXI7XG4gICAgICAgIHRoaXMubG9naW5Ub0FjY291bnQgPSBsb2dpblRvQWNjb3VudDtcbiAgICAgICAgdGhpcy5sb2dPdXQgPSBsb2dPdXQ7XG5cbiAgICBcdC8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIFx0ZnVuY3Rpb24gY2hlY2tJZlVzZXJFeGlzdHMoaW5wdXRVc2VybmFtZSkge1xuXG4gICAgXHRcdHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG5cbiAgICBcdFx0dmFyIGRvZXNVc2VyRXhpc3QgPSBmYWxzZTtcbiAgICBcdFx0dmFyIHVzZXJzUmVmID0gbmV3ICR3aW5kb3cuRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMICsgJy91c2VycycpO1xuXG4gICAgXHRcdHVzZXJzUmVmLm9uY2UoJ3ZhbHVlJywgZnVuY3Rpb24oZGF0YVNuYXBzaG90KSB7XG5cbiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVNuYXBzaG90LmZvckVhY2goZnVuY3Rpb24odXNlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVzZXIudmFsKCkudXNlck5hbWUgPT09IGlucHV0VXNlcm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2VzVXNlckV4aXN0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShkb2VzVXNlckV4aXN0KTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgIFx0XHR9KTtcblxuICAgIFx0XHRyZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcblxuICAgIFx0fVxuXG4gICAgXHRmdW5jdGlvbiBjcmVhdGVOZXdVc2VyKGlucHV0RW1haWwsIGlucHV0UGFzc3dvcmQsIGlucHV0VXNlcm5hbWUpIHtcblxuICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcblxuICAgIFx0XHRBdXRoV3JhcHBlci4kY3JlYXRlVXNlcih7XG4gICAgXHRcdFx0ZW1haWw6IGlucHV0RW1haWwsXG4gICAgXHRcdFx0cGFzc3dvcmQ6IGlucHV0UGFzc3dvcmRcbiAgICBcdFx0fSkudGhlbihmdW5jdGlvbih1c2VyRGF0YSkge1xuXG4gICAgXHRcdFx0Ly8gQ3JlYXRlIGEgZGF0YSBlbnRyeSBmb3IgdGhlIG5ldyB1c2VybmFtZS5cbiAgICBcdFx0XHRuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKS5jaGlsZCgndXNlcnMvJyArIHVzZXJEYXRhLnVpZCkuc2V0KHtcblxuICAgIFx0XHRcdFx0dXNlck5hbWU6IGlucHV0VXNlcm5hbWUsXG4gICAgXHRcdFx0XHRyb2xlOiAnVXNlcidcblxuICAgIFx0XHRcdH0sIGZ1bmN0aW9uKGVycm9yRGF0YSkge1xuICAgIFx0XHRcdFx0Y29uc29sZS5lcnJvcihlcnJvckRhdGEpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXJyb3JEYXRhLmNvZGU7XG4gICAgXHRcdFx0fSk7XG5cbiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgYSBkYXRhIGVudHJ5IGZvciB0aGUgdXNlcidzIGF2YXRhci5cbiAgICAgICAgICAgICAgICBuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKS5jaGlsZCgnYXZhdGFycycpLmNoaWxkKGlucHV0VXNlcm5hbWUpLnNldCgnaHR0cDovL2FwaS5hZG9yYWJsZS5pby9hdmF0YXJzLzQyLycgKyBpbnB1dFVzZXJuYW1lKTtcblxuICAgIFx0XHRcdC8vIExvZyB0aGUgdXNlciBpbi5cbiAgICBcdFx0XHRBdXRoV3JhcHBlci4kYXV0aFdpdGhQYXNzd29yZCh7XG4gICAgXHRcdFx0XHRlbWFpbDogaW5wdXRFbWFpbCxcbiAgICBcdFx0XHRcdHBhc3N3b3JkOiBpbnB1dFBhc3N3b3JkXG4gICAgXHRcdFx0fSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgnQUNDT1VOVF9DUkVBVEVEJyk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICBcdFx0fSkuY2F0Y2goZnVuY3Rpb24oZXJyb3JEYXRhKSB7XG5cbiAgICBcdFx0XHRjb25zb2xlLmVycm9yKGVycm9yRGF0YSk7XG5cbiAgICBcdFx0XHRpZiAoZXJyb3JEYXRhLmNvZGUgPT09ICdFTUFJTF9UQUtFTicpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShlcnJvckRhdGEuY29kZSk7XG4gICAgXHRcdFx0fVxuXG4gICAgXHRcdH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcblxuICAgIFx0fVxuXG4gICAgICAgIGZ1bmN0aW9uIGxvZ2luVG9BY2NvdW50KGlucHV0RW1haWwsIGlucHV0UGFzc3dvcmQpIHtcblxuICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcblxuICAgICAgICAgICAgQXV0aFdyYXBwZXIuJGF1dGhXaXRoUGFzc3dvcmQoe1xuICAgICAgICAgICAgICAgIGVtYWlsOiBpbnB1dEVtYWlsLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBpbnB1dFBhc3N3b3JkXG4gICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKGF1dGhEYXRhKSB7XG5cbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCdMT0dJTl9TVUNDRVNTJyk7XG5cbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycm9yRGF0YSkge1xuXG4gICAgICAgICAgICAgICAgaWYgKGVycm9yRGF0YS5jb2RlID09PSAnSU5WQUxJRF9VU0VSJykge1xuICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCdJTlZBTElEX1VTRVInKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yRGF0YS5jb2RlID09PSAnSU5WQUxJRF9QQVNTV09SRCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgnSU5WQUxJRF9QQVNTV09SRCcpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBsb2dPdXQoKSB7XG4gICAgICAgICAgICBBdXRoV3JhcHBlci4kdW5hdXRoKCk7XG4gICAgICAgICAgICAkcm9vdFNjb3BlLnVuYmluZEZ1bmN0aW9uKCk7XG4gICAgICAgIH1cblxuICAgIH1cbn0pKCk7IiwiKGZ1bmN0aW9uKCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIGFuZ3VsYXJcbiAgICAgICAgLm1vZHVsZSgndmcuYXBwJylcbiAgICAgICAgLmZhY3RvcnkoJ0F1dGhXcmFwcGVyJywgQXV0aFdyYXBwZXIpO1xuXG4gICAgLyogQG5nSW5qZWN0ICovXG4gICAgZnVuY3Rpb24gQXV0aFdyYXBwZXIoJGZpcmViYXNlQXV0aCwgRklSRUJBU0VEQVRBKSB7XG5cbiAgICAgICAgdmFyIHJlZiA9IG5ldyBGaXJlYmFzZShGSVJFQkFTRURBVEEuRkJVUkwpO1xuICAgICAgICByZXR1cm4gJGZpcmViYXNlQXV0aChyZWYpO1xuXG4gICAgfVxuICAgIFxufSkoKTsiLCIoZnVuY3Rpb24oKSB7XG4gICAgJ3VzZSBzdHJpY3QnO1xuXG4gICAgYW5ndWxhclxuICAgICAgICAubW9kdWxlKCd2Zy5hcHAnKVxuICAgICAgICAuZGlyZWN0aXZlKCd2Z0dhbWVzTGlzdCcsIHZnR2FtZXNMaXN0KTtcblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIHZnR2FtZXNMaXN0ICgpIHtcbiAgICAgICAgdmFyIGRpcmVjdGl2ZSA9IHtcbiAgICAgICAgICAgIGJpbmRUb0NvbnRyb2xsZXI6IHRydWUsXG4gICAgICAgICAgICBjb250cm9sbGVyOiBHYW1lc0xpc3RDb250cm9sbGVyLFxuICAgICAgICAgICAgY29udHJvbGxlckFzOiAndm0nLFxuICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJyxcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnLi9hcHAvZXZlbnRDb21wb25lbnRzL2dhbWVzTGlzdC5kaXJlY3RpdmUuaHRtJyxcbiAgICAgICAgICAgIHNjb3BlOiBmYWxzZSxcbiAgICAgICAgICAgIHRyYW5zY2x1ZGU6IGZhbHNlXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBkaXJlY3RpdmU7XG4gICAgfVxuXG4gICAgLyogQG5nSW5qZWN0ICovXG4gICAgZnVuY3Rpb24gR2FtZXNMaXN0Q29udHJvbGxlcigkc2NvcGUsIGV2ZW50U2VydmljZSkge1xuICAgICAgICAvKiBqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovXG4gICAgXHR2YXIgdm0gPSB0aGlzO1xuXG4gICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7IHJldHVybiBldmVudFNlcnZpY2UuZ2V0R2FtZUxpc3RPYmplY3QoKTsgfSwgZnVuY3Rpb24obW9kZWwpIHtcbiAgICAgICAgICAgICRzY29wZS4kcGFyZW50LiRwYXJlbnQuZXZlbnQuZ2FtZUxpc3QgPSBtb2RlbDtcbiAgICAgICAgfSwgdHJ1ZSk7XG4gICAgfVxufSkoKTsiLCIoZnVuY3Rpb24oKSB7XG4gICAgJ3VzZSBzdHJpY3QnO1xuXG4gICAgYW5ndWxhclxuICAgICAgICAubW9kdWxlKCd2Zy5hcHAnKVxuICAgICAgICAuZGlyZWN0aXZlKCd2Z011bHRpR2FtZUxlYWRlcmJvYXJkJywgdmdNdWx0aUdhbWVMZWFkZXJib2FyZCk7XG5cbiAgICAvKiBAbmdJbmplY3QgKi9cbiAgICBmdW5jdGlvbiB2Z011bHRpR2FtZUxlYWRlcmJvYXJkICgpIHtcbiAgICAgICAgdmFyIGRpcmVjdGl2ZSA9IHtcbiAgICAgICAgICAgIGJpbmRUb0NvbnRyb2xsZXI6IHRydWUsXG4gICAgICAgICAgICBjb250cm9sbGVyOiBNdWx0aUdhbWVMZWFkZXJib2FyZENvbnRyb2xsZXIsXG4gICAgICAgICAgICBjb250cm9sbGVyQXM6ICd2bScsXG4gICAgICAgICAgICByZXN0cmljdDogJ0UnLFxuICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICcuL2FwcC9ldmVudENvbXBvbmVudHMvbXVsdGlHYW1lTGVhZGVyYm9hcmQuZGlyZWN0aXZlLmh0bScsXG4gICAgICAgICAgICBzY29wZTogZmFsc2UsXG4gICAgICAgICAgICB0cmFuc2NsdWRlOiBmYWxzZVxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gZGlyZWN0aXZlO1xuICAgIH1cblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIE11bHRpR2FtZUxlYWRlcmJvYXJkQ29udHJvbGxlcigkc2NvcGUsIGV2ZW50U2VydmljZSkge1xuICAgICAgICAvKiBqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovXG4gICAgXHR2YXIgdm0gPSB0aGlzO1xuXG4gICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7IHJldHVybiBldmVudFNlcnZpY2UuZ2V0TGVhZGVyYm9hcmRMZW5ndGhWYWx1ZSgpOyB9LCBmdW5jdGlvbihtb2RlbCkge1xuICAgICAgICAgICAgJHNjb3BlLiRwYXJlbnQuJHBhcmVudC5ldmVudC5sZWFkZXJib2FyZExlbmd0aCA9IG1vZGVsO1xuICAgICAgICB9LCB0cnVlKTtcblxuICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgeyByZXR1cm4gZXZlbnRTZXJ2aWNlLmdldFN1bW1hcml6ZWRMZWFkZXJib2FyZE9iamVjdCgpOyB9LCBmdW5jdGlvbihtb2RlbCkge1xuICAgICAgICAgICAgJHNjb3BlLiRwYXJlbnQuJHBhcmVudC5ldmVudC5zdW1tYXJpemVkTGVhZGVyYm9hcmQgPSBtb2RlbDtcbiAgICAgICAgfSwgdHJ1ZSk7XG4gICAgfVxufSkoKTsiLCIoZnVuY3Rpb24oKSB7XG4gICAgJ3VzZSBzdHJpY3QnO1xuXG4gICAgYW5ndWxhclxuICAgICAgICAubW9kdWxlKCd2Zy5hcHAnKVxuICAgICAgICAuZGlyZWN0aXZlKCd2Z1NpbmdsZUdhbWVMZWFkZXJib2FyZCcsIHZnU2luZ2xlR2FtZUxlYWRlcmJvYXJkKTtcblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIHZnU2luZ2xlR2FtZUxlYWRlcmJvYXJkICgpIHtcbiAgICAgICAgdmFyIGRpcmVjdGl2ZSA9IHtcbiAgICAgICAgICAgIGJpbmRUb0NvbnRyb2xsZXI6IHRydWUsXG4gICAgICAgICAgICBjb250cm9sbGVyOiBTaW5nbGVHYW1lTGVhZGVyYm9hcmRDb250cm9sbGVyLFxuICAgICAgICAgICAgY29udHJvbGxlckFzOiAndm0nLFxuICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJyxcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnLi9hcHAvZXZlbnRDb21wb25lbnRzL3NpbmdsZUdhbWVMZWFkZXJib2FyZC5kaXJlY3RpdmUuaHRtJyxcbiAgICAgICAgICAgIHNjb3BlOiBmYWxzZSxcbiAgICAgICAgICAgIHRyYW5zY2x1ZGU6IGZhbHNlXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBkaXJlY3RpdmU7XG4gICAgfVxuXG4gICAgLyogQG5nSW5qZWN0ICovXG4gICAgZnVuY3Rpb24gU2luZ2xlR2FtZUxlYWRlcmJvYXJkQ29udHJvbGxlcigkc2NvcGUsIGV2ZW50U2VydmljZSkge1xuICAgICAgICAvKiBqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovXG4gICAgXHR2YXIgdm0gPSB0aGlzO1xuXG4gICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7IHJldHVybiBldmVudFNlcnZpY2UuZ2V0TGVhZGVyYm9hcmRMZW5ndGhWYWx1ZSgpOyB9LCBmdW5jdGlvbihtb2RlbCkge1xuICAgICAgICAgICAgJHNjb3BlLiRwYXJlbnQuJHBhcmVudC5ldmVudC5sZWFkZXJib2FyZExlbmd0aCA9IG1vZGVsO1xuICAgICAgICB9LCB0cnVlKTtcblxuICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgeyByZXR1cm4gZXZlbnRTZXJ2aWNlLmdldFN1bW1hcml6ZWRMZWFkZXJib2FyZE9iamVjdCgpOyB9LCBmdW5jdGlvbihtb2RlbCkge1xuICAgICAgICAgICAgJHNjb3BlLiRwYXJlbnQuJHBhcmVudC5ldmVudC5zdW1tYXJpemVkTGVhZGVyYm9hcmQgPSBtb2RlbDtcbiAgICAgICAgfSwgdHJ1ZSk7XG4gICAgfVxufSkoKTsiLCIoZnVuY3Rpb24oKSB7XG4gICAgJ3VzZSBzdHJpY3QnO1xuXG4gICAgYW5ndWxhclxuICAgICAgICAubW9kdWxlKCd2Zy5hcHAnKVxuICAgICAgICAuZGlyZWN0aXZlKCd2Z1N0aWNreU1lc3NhZ2UnLCB2Z1N0aWNreU1lc3NhZ2UpO1xuXG4gICAgLyogQG5nSW5qZWN0ICovXG4gICAgZnVuY3Rpb24gdmdTdGlja3lNZXNzYWdlICgpIHtcbiAgICAgICAgdmFyIGRpcmVjdGl2ZSA9IHtcbiAgICAgICAgICAgIGJpbmRUb0NvbnRyb2xsZXI6IHRydWUsXG4gICAgICAgICAgICBjb250cm9sbGVyOiBTdGlja3lNZXNzYWdlQ29udHJvbGxlcixcbiAgICAgICAgICAgIGNvbnRyb2xsZXJBczogJ3ZtJyxcbiAgICAgICAgICAgIHJlc3RyaWN0OiAnRScsXG4gICAgICAgICAgICB0ZW1wbGF0ZVVybDogJy4vYXBwL2V2ZW50Q29tcG9uZW50cy9zdGlja3lNZXNzYWdlLmRpcmVjdGl2ZS5odG0nLFxuICAgICAgICAgICAgc2NvcGU6IHtcbiAgICAgICAgICAgIFx0cHJvcGVydGllczogJz0nXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBkaXJlY3RpdmU7XG4gICAgfVxuXG4gICAgLyogQG5nSW5qZWN0ICovXG4gICAgZnVuY3Rpb24gU3RpY2t5TWVzc2FnZUNvbnRyb2xsZXIoJHRpbWVvdXQpIHtcbiAgICAgICAgLyoganNoaW50IHZhbGlkdGhpczogdHJ1ZSAqL1xuICAgIFx0dmFyIHZtID0gdGhpcztcbiAgICB9XG59KSgpOyIsIihmdW5jdGlvbigpIHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICBhbmd1bGFyXG4gICAgICAgIC5tb2R1bGUoJ3ZnLmFwcCcpXG4gICAgICAgIC5zZXJ2aWNlKCdldmVudFNlcnZpY2UnLCBldmVudFNlcnZpY2UpO1xuXG4gICAgLyogQG5nSW5qZWN0ICovXG4gICAgZnVuY3Rpb24gZXZlbnRTZXJ2aWNlKCRxLCAkZmlsdGVyLCAkZmlyZWJhc2VPYmplY3QsICRmaXJlYmFzZUFycmF5LCBGSVJFQkFTRURBVEEpIHtcblxuICAgICAgICB2YXIgX2V2ZW50UHJvcGVydGllcyA9IG51bGw7XG4gICAgICAgIHZhciBfZ2FtZUxpc3QgPSBudWxsO1xuICAgICAgICB2YXIgX2xlYWRlcmJvYXJkTGVuZ3RoID0gbnVsbDtcbiAgICAgICAgdmFyIF9zdW1tYXJpemVkTGVhZGVyYm9hcmQgPSBudWxsO1xuICAgICAgICB2YXIgX3RlYW1MaXN0ID0gbnVsbDtcblxuICAgICAgICB0aGlzLmNyZWF0ZU11bHRpR2FtZUZpbmFsU3RhbmRpbmdzID0gY3JlYXRlTXVsdGlHYW1lRmluYWxTdGFuZGluZ3M7XG4gICAgICAgIHRoaXMuZ2V0RXZlbnRQcm9wZXJ0aWVzID0gZ2V0RXZlbnRQcm9wZXJ0aWVzO1xuICAgICAgICB0aGlzLmdldEV2ZW50UHJvcGVydGllc09iamVjdCA9IGdldEV2ZW50UHJvcGVydGllc09iamVjdDtcbiAgICAgICAgdGhpcy5nZXRHYW1lRGF0YSA9IGdldEdhbWVEYXRhO1xuICAgICAgICB0aGlzLmdldEdhbWVMaXN0T2JqZWN0ID0gZ2V0R2FtZUxpc3RPYmplY3Q7XG4gICAgICAgIHRoaXMuZ2V0R2FtZXNMaXN0ID0gZ2V0R2FtZXNMaXN0O1xuICAgICAgICB0aGlzLmdldExlYWRlcmJvYXJkTGVuZ3RoVmFsdWUgPSBnZXRMZWFkZXJib2FyZExlbmd0aFZhbHVlO1xuICAgICAgICB0aGlzLmdldE11bHRpR2FtZUxlYWRlcmJvYXJkID0gZ2V0TXVsdGlHYW1lTGVhZGVyYm9hcmQ7XG4gICAgICAgIHRoaXMuZ2V0UGxheWVyU2NvcmVzID0gZ2V0UGxheWVyU2NvcmVzO1xuICAgICAgICB0aGlzLmdldFNpbmdsZUdhbWVMZWFkZXJib2FyZCA9IGdldFNpbmdsZUdhbWVMZWFkZXJib2FyZDtcbiAgICAgICAgdGhpcy5nZXRTdW1tYXJpemVkTGVhZGVyYm9hcmRPYmplY3QgPSBnZXRTdW1tYXJpemVkTGVhZGVyYm9hcmRPYmplY3Q7XG4gICAgICAgIHRoaXMuZ2V0VGVhbUxpc3RPYmplY3QgPSBnZXRUZWFtTGlzdE9iamVjdDtcbiAgICAgICAgdGhpcy5sb2FkRXZlbnRQcm9wZXJ0aWVzID0gbG9hZEV2ZW50UHJvcGVydGllcztcblxuICAgICAgICAvLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTXVsdGlHYW1lRmluYWxTdGFuZGluZ3MoaW5wdXRFdmVudCkge1xuXG4gICAgICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIGZpbmFsIHN0YW5kaW5ncyBvZiB0aGUgZXZlbnQuXG4gICAgICAgICAgICBnZXRNdWx0aUdhbWVMZWFkZXJib2FyZChpbnB1dEV2ZW50KS50aGVuKGZ1bmN0aW9uIHRoZW4obW9kZWwpIHtcblxuICAgICAgICAgICAgICAgIHZhciByZWYgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKTtcbiAgICAgICAgICAgICAgICB2YXIgaW5wdXRFdmVudFN0YW5kaW5ncyA9ICRmaXJlYmFzZU9iamVjdChcbiAgICAgICAgICAgICAgICAgICAgcmVmXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2hpbGQoJ3N0YW5kaW5ncycpXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2hpbGQoaW5wdXRFdmVudClcbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgaW5wdXRFdmVudFN0YW5kaW5ncy4kbG9hZGVkKCkudGhlbihmdW5jdGlvbigpIHtcblxuICAgICAgICAgICAgICAgICAgICBtb2RlbC5mb3JFYWNoKGZ1bmN0aW9uKHN0YW5kaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnB1dEV2ZW50U3RhbmRpbmdzW3N0YW5kaW5nLmtleV0gPSBzdGFuZGluZy5wb3NpdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaW5wdXRFdmVudFN0YW5kaW5ncy4kc2F2ZSgpO1xuXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFByb3BlcnRpZXMoaW5wdXRFdmVudCkge1xuXG4gICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpO1xuXG4gICAgICAgIFx0dmFyIHJlZiA9IG5ldyBGaXJlYmFzZShGSVJFQkFTRURBVEEuRkJVUkwpO1xuICAgICAgICBcdHZhciBldmVudFByb3BlcnRpZXMgPSAkZmlyZWJhc2VPYmplY3QoXG4gICAgICAgIFx0XHRyZWZcbiAgICAgICAgXHRcdFx0LmNoaWxkKCdjb250ZXN0cycpXG4gICAgICAgIFx0XHRcdC5jaGlsZChpbnB1dEV2ZW50KVxuICAgICAgICBcdFx0XHQuY2hpbGQoJ3Byb3BlcnRpZXMnKVxuICAgICAgICBcdCk7XG5cbiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoZXZlbnRQcm9wZXJ0aWVzKTtcblxuICAgICAgICBcdHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFByb3BlcnRpZXNPYmplY3QoKSB7XG4gICAgICAgICAgICByZXR1cm4gX2V2ZW50UHJvcGVydGllcztcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0UGxhY2VTY29yZXMoKSB7XG5cbiAgICAgICAgICAgIF9nYW1lTGlzdC5mb3JFYWNoKGZ1bmN0aW9uKGdhbWUpIHtcblxuICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlIGFyZSBzY29yZXMsIGdldCB0aGUgdG9wIG9uZS5cbiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5zY29yZXMpIHtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcmVzQXJyYXkgPSAkLm1hcChnYW1lLnNjb3JlcywgZnVuY3Rpb24oZWwpIHsgcmV0dXJuIGVsOyB9KTtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmVzQXJyYXkgPSAkZmlsdGVyKCdvcmRlckJ5Jykoc2NvcmVzQXJyYXksICctc2NvcmUnKTtcbiAgICAgICAgICAgICAgICAgICAgZ2FtZS5maXJzdFNjb3JlID0gc2NvcmVzQXJyYXlbMF07XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXRHYW1lRGF0YShpbnB1dEV2ZW50LCBpbnB1dEdhbWUpIHtcblxuICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcblxuICAgICAgICAgICAgdmFyIHJlZiA9IG5ldyBGaXJlYmFzZShGSVJFQkFTRURBVEEuRkJVUkwpO1xuXG4gICAgICAgICAgICBnZXRHYW1lc0xpc3QoaW5wdXRFdmVudCkudGhlbihmdW5jdGlvbihnYW1lc0xpc3QpIHtcblxuICAgICAgICAgICAgICAgIGdhbWVzTGlzdC5mb3JFYWNoKGZ1bmN0aW9uKGdhbWUpIHtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZ2FtZS5jYW1lbE5hbWUgPT09IGlucHV0R2FtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShnYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcblxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZ2V0R2FtZUxpc3RPYmplY3QoKSB7XG4gICAgICAgICAgICByZXR1cm4gX2dhbWVMaXN0O1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZ2V0R2FtZXNMaXN0KGlucHV0RXZlbnQpIHtcblxuICAgICAgICBcdHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG5cbiAgICAgICAgXHR2YXIgcmVmID0gbmV3IEZpcmViYXNlKEZJUkVCQVNFREFUQS5GQlVSTCk7XG4gICAgICAgIFx0dmFyIGdhbWVzTGlzdCA9ICRmaXJlYmFzZUFycmF5KFxuICAgICAgICBcdFx0cmVmXG4gICAgICAgIFx0XHRcdC5jaGlsZCgnY29udGVzdHMnKVxuICAgICAgICBcdFx0XHQuY2hpbGQoaW5wdXRFdmVudClcbiAgICAgICAgXHRcdFx0LmNoaWxkKCdhY3RpdmVHYW1lcycpXG4gICAgICAgIFx0KTtcblxuICAgICAgICBcdGdhbWVzTGlzdC4kbG9hZGVkKCkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgXHRcdGRlZmVycmVkLnJlc29sdmUoZ2FtZXNMaXN0KTtcbiAgICAgICAgXHR9KTtcblxuICAgICAgICBcdHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXRMZWFkZXJib2FyZExlbmd0aFZhbHVlKCkge1xuICAgICAgICAgICAgcmV0dXJuIF9sZWFkZXJib2FyZExlbmd0aDtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGdldE11bHRpR2FtZUxlYWRlcmJvYXJkKGlucHV0RXZlbnQpIHtcblxuICAgICAgICBcdHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG5cbiAgICAgICAgXHQvLyBXZSBuZWVkIHRvIGdldCB0aGUgdG9wIDEyIHBsYXllcnMgZm9yIGV2ZXJ5IGdhbWUuXG4gICAgICAgIFx0dmFyIHBsYXllclBvaW50cyA9IHt9O1xuXG4gICAgICAgIFx0Z2V0R2FtZXNMaXN0KGlucHV0RXZlbnQpLnRoZW4oZnVuY3Rpb24gdGhlbihtb2RlbCkge1xuXG4gICAgICAgIFx0XHR2YXIgZ2FtZXNMaXN0ID0gbW9kZWw7XG4gICAgICAgIFx0XHRnYW1lc0xpc3QuZm9yRWFjaChmdW5jdGlvbihnYW1lKSB7XG5cbiAgICAgICAgXHRcdFx0aWYgKGdhbWUuc2NvcmVzKSB7XG5cbiAgICAgICAgXHRcdFx0XHQvLyBDb252ZXJ0IHRoZSBnYW1lJ3Mgc2NvcmVzIHRvIGFuIGFycmF5LlxuICAgICAgICBcdFx0XHRcdHZhciBzY29yZXNBcnJheSA9ICQubWFwKGdhbWUuc2NvcmVzLCBmdW5jdGlvbihlbCkgeyByZXR1cm4gZWw7IH0pO1xuICAgICAgICBcdFx0XHRcdHNjb3Jlc0FycmF5ID0gJGZpbHRlcignb3JkZXJCeScpKHNjb3Jlc0FycmF5LCAnLXNjb3JlJyk7XG5cbiAgICAgICAgXHRcdFx0XHR2YXIgdG90YWxBd2FyZCA9IDEyO1xuXG4gICAgICAgIFx0XHRcdFx0Ly8gSXRlcmF0ZSB0aHJvdWdoIHRoZSB0b3Agc2NvcmVzIGF3YXJkaW5nIHBvaW50cy5cbiAgICAgICAgXHRcdFx0XHRmb3IgKHZhciBpID0gMDsgaSA8IHNjb3Jlc0FycmF5Lmxlbmd0aDsgaSsrKSB7XG5cbiAgICAgICAgXHRcdFx0XHRcdGlmICghcGxheWVyUG9pbnRzW3Njb3Jlc0FycmF5W2ldLnVzZXJOYW1lXSkge1xuICAgICAgICBcdFx0XHRcdFx0XHRwbGF5ZXJQb2ludHNbc2NvcmVzQXJyYXlbaV0udXNlck5hbWVdID0ge1xuICAgICAgICBcdFx0XHRcdFx0XHRcdHBvaW50czogMFxuICAgICAgICBcdFx0XHRcdFx0XHR9O1xuICAgICAgICBcdFx0XHRcdFx0fVxuXG4gICAgICAgIFx0XHRcdFx0XHRwbGF5ZXJQb2ludHNbc2NvcmVzQXJyYXlbaV0udXNlck5hbWVdLnBvaW50cyArPSB0b3RhbEF3YXJkO1xuXG4gICAgICAgIFx0XHRcdFx0XHRpZiAodG90YWxBd2FyZCA+IDApIHtcbiAgICAgICAgXHRcdFx0XHRcdFx0dG90YWxBd2FyZCAtPSAxO1xuICAgICAgICBcdFx0XHRcdFx0fVxuXG4gICAgICAgIFx0XHRcdFx0fVxuXG4gICAgICAgIFx0XHRcdH1cblxuICAgICAgICBcdFx0fSk7XG5cbiAgICAgICAgXHRcdC8vIEZpbmQgYW5kIHJlc29sdmUgdGllcy5cbiAgICAgICAgXHRcdHBsYXllclBvaW50cyA9ICRmaWx0ZXIoJ29yZGVyT2JqZWN0QnknKShwbGF5ZXJQb2ludHMsICdwb2ludHMnLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB2YXIgaGF2ZUJvdHRvbVNjb3JlcnNGbG9vciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciBmbG9vclJhbmdlID0gMDtcbiAgICAgICAgXHRcdGZvciAodmFyIGkgPSAwOyBpIDwgcGxheWVyUG9pbnRzLmxlbmd0aDsgaSArPSAxKSB7XG5cbiAgICAgICAgXHRcdFx0aWYgKHBsYXllclBvaW50c1tpLTFdICYmIHBsYXllclBvaW50c1tpXS5wb2ludHMgJiYgcGxheWVyUG9pbnRzW2ktMV0ucG9pbnRzKSB7XG5cbiAgICAgICAgXHRcdFx0XHRpZiAocGxheWVyUG9pbnRzW2ldLnBvaW50cyA9PT0gcGxheWVyUG9pbnRzW2ktMV0ucG9pbnRzKSB7XG4gICAgICAgIFx0XHRcdFx0XHRwbGF5ZXJQb2ludHNbaV0ucG9zaXRpb24gPSBwbGF5ZXJQb2ludHNbaS0xXS5wb3NpdGlvbjtcbiAgICAgICAgXHRcdFx0XHR9IGVsc2Uge1xuICAgICAgICBcdFx0XHRcdFx0cGxheWVyUG9pbnRzW2ldLnBvc2l0aW9uID0gKGkrMSk7XG4gICAgICAgIFx0XHRcdFx0fVxuXG4gICAgICAgIFx0XHRcdH0gZWxzZSB7XG5cbiAgICAgICAgXHRcdFx0XHRpZiAoaSA9PT0gMCkge1xuICAgICAgICBcdFx0XHRcdFx0cGxheWVyUG9pbnRzW2ldLnBvc2l0aW9uID0gMTtcbiAgICAgICAgXHRcdFx0XHR9IGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXZlQm90dG9tU2NvcmVyc0Zsb29yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdldCBjb3VudCBvZiBwbGF5ZXJzIGluIG9uZSBwb3NpdGlvbiBoaWdoZXIuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBnZXRTY29yZUNvdW50T2YgPSBwbGF5ZXJQb2ludHNbaS0xXS5wb2ludHM7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwbGF5ZXJQb2ludHMubGVuZ3RoOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXJQb2ludHNbal0ucG9pbnRzID09PSBnZXRTY29yZUNvdW50T2YpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG9vclJhbmdlICs9IDE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXZlQm90dG9tU2NvcmVyc0Zsb29yID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgXHRcdFx0XHRcdHBsYXllclBvaW50c1tpXS5wb3NpdGlvbiA9IChwbGF5ZXJQb2ludHMubGVuZ3RoICsgMSkgLSBmbG9vclJhbmdlO1xuICAgICAgICBcdFx0XHRcdH1cblxuICAgICAgICBcdFx0XHR9XG5cbiAgICAgICAgXHRcdH1cblxuICAgICAgICBcdFx0ZGVmZXJyZWQucmVzb2x2ZShwbGF5ZXJQb2ludHMpO1xuXG4gICAgICAgIFx0fSk7XG5cblx0XHRcdHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXRTaW5nbGVHYW1lTGVhZGVyYm9hcmQoaW5wdXRFdmVudCkge1xuXG4gICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpO1xuXG4gICAgICAgICAgICB2YXIgcmVmID0gbmV3IEZpcmViYXNlKEZJUkVCQVNFREFUQS5GQlVSTCk7XG4gICAgICAgICAgICB2YXIgbGVhZGVyYm9hcmREYXRhID0gJGZpcmViYXNlQXJyYXkoXG4gICAgICAgICAgICAgICAgcmVmXG4gICAgICAgICAgICAgICAgICAgIC5jaGlsZCgnY29udGVzdHMnKVxuICAgICAgICAgICAgICAgICAgICAuY2hpbGQoaW5wdXRFdmVudClcbiAgICAgICAgICAgICAgICAgICAgLmNoaWxkKCdzY29yZXMnKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShsZWFkZXJib2FyZERhdGEpO1xuXG4gICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcblxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZ2V0U3VtbWFyaXplZExlYWRlcmJvYXJkT2JqZWN0KCkge1xuICAgICAgICAgICAgcmV0dXJuIF9zdW1tYXJpemVkTGVhZGVyYm9hcmQ7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXRUZWFtTGlzdE9iamVjdCgpIHtcbiAgICAgICAgICAgIHJldHVybiBfdGVhbUxpc3Q7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXRQbGF5ZXJTY29yZXMoaW5wdXRFdmVudCwgaW5wdXRHYW1lc0xpc3QsIGlucHV0UGxheWVyKSB7XG5cbiAgICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG5cbiAgICAgICAgICAgIHZhciBkaXNwbGF5U2NvcmVzID0gW107XG5cbiAgICAgICAgICAgIC8vIEl0ZXJhdGUgdGhyb3VnaCBldmVyeSBnYW1lLlxuICAgICAgICAgICAgaW5wdXRHYW1lc0xpc3QuZm9yRWFjaChmdW5jdGlvbihnYW1lKSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoZ2FtZS5zY29yZXMpIHtcblxuICAgICAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IHRoZSBnYW1lJ3Mgc2NvcmVzIHRvIGFuIGFycmF5LlxuICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcmVzQXJyYXkgPSAkLm1hcChnYW1lLnNjb3JlcywgZnVuY3Rpb24oZWwpIHsgcmV0dXJuIGVsOyB9KTtcbiAgICAgICAgICAgICAgICAgICAgc2NvcmVzQXJyYXkgPSAkZmlsdGVyKCdvcmRlckJ5Jykoc2NvcmVzQXJyYXksICctc2NvcmUnKTtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgdG90YWxBd2FyZCA9IDEyO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIEl0ZXJhdGUgdGhyb3VnaCB0aGUgc2NvcmVzIHN0YXJ0aW5nIGZyb20gdGhlIHRvcCBhbmQgZmluZCBvdXIgdXNlci5cbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzY29yZXNBcnJheS5sZW5ndGg7IGkrKykge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3VuZCBvdXIgcGxheWVyLlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3Jlc0FycmF5W2ldLnVzZXJOYW1lID09PSBpbnB1dFBsYXllcikge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1Njb3JlT2JqZWN0ID0gZ2FtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTY29yZU9iamVjdC5wb3NpdGlvbiA9IGkrMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTY29yZU9iamVjdC5zY29yZSA9IHNjb3Jlc0FycmF5W2ldLnNjb3JlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Njb3JlT2JqZWN0LnBvaW50c0Vhcm5lZCA9IHRvdGFsQXdhcmQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2NvcmVPYmplY3QuaW5wVXJsID0gc2NvcmVzQXJyYXlbaV0uaW5wVXJsID8gc2NvcmVzQXJyYXlbaV0uaW5wVXJsIDogbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTY29yZU9iamVjdC50d2l0Y2hVcmwgPSBzY29yZXNBcnJheVtpXS50d2l0Y2hVcmwgPyBzY29yZXNBcnJheVtpXS50d2l0Y2hVcmwgOiBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Njb3JlT2JqZWN0Lm1hbWVWZXJzaW9uID0gc2NvcmVzQXJyYXlbaV0ubWFtZVZlcnNpb24gPyBzY29yZXNBcnJheVtpXS5tYW1lVmVyc2lvbiA6IG51bGw7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5U2NvcmVzLnB1c2gobmV3U2NvcmVPYmplY3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsQXdhcmQgPSAxMjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG90YWxBd2FyZCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxBd2FyZCAtPSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGRpc3BsYXlTY29yZXMpO1xuXG4gICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcblxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gbG9hZEV2ZW50UHJvcGVydGllcyhpbnB1dEV2ZW50KSB7XG5cbiAgICAgICAgICAgIHZhciByZWYgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKTtcbiAgICAgICAgICAgIHZhciBpbnB1dEV2ZW50UHJvcGVydGllcyA9ICRmaXJlYmFzZU9iamVjdChcbiAgICAgICAgICAgICAgICByZWZcbiAgICAgICAgICAgICAgICAgICAgLmNoaWxkKCdjb250ZXN0cycpXG4gICAgICAgICAgICAgICAgICAgIC5jaGlsZChpbnB1dEV2ZW50KVxuICAgICAgICAgICAgICAgICAgICAuY2hpbGQoJ3Byb3BlcnRpZXMnKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaW5wdXRFdmVudFByb3BlcnRpZXMuJGxvYWRlZCgpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgX2V2ZW50UHJvcGVydGllcyA9IGlucHV0RXZlbnRQcm9wZXJ0aWVzO1xuXG4gICAgICAgICAgICAgICAgLy8gSWYgdGhpcyBpcyBhIG11bHRpZ2FtZSBldmVudCwgZ2V0IHRoZSBkYXRhIG5lZWRlZCBmb3IgbXVsdGlnYW1lIGNvbXBvbmVudHMuXG4gICAgICAgICAgICAgICAgaWYgKF9ldmVudFByb3BlcnRpZXMuZm9ybWF0Lm11bHRpR2FtZSkge1xuXG4gICAgICAgICAgICAgICAgICAgIGdldEdhbWVzTGlzdChpbnB1dEV2ZW50KS50aGVuKGZ1bmN0aW9uIHRoZW4obW9kZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF9nYW1lTGlzdCA9IG1vZGVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgZ2V0Rmlyc3RQbGFjZVNjb3JlcygpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBnZXRNdWx0aUdhbWVMZWFkZXJib2FyZChpbnB1dEV2ZW50KS50aGVuKGZ1bmN0aW9uIHRoZW4obW9kZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsZWFkZXJib2FyZCA9IG1vZGVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgX2xlYWRlcmJvYXJkTGVuZ3RoID0gbGVhZGVyYm9hcmQubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgX3N1bW1hcml6ZWRMZWFkZXJib2FyZCA9IGxlYWRlcmJvYXJkLnNsaWNlKDAsIDgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgaXMgYSBzaW5nbGUgZ2FtZSBldmVudCwgZ2V0IHRoZSBkYXRhIG5lZWRlZCBmb3Igc2luZ2xlIGdhbWUgY29tcG9uZW50cy5cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgICAgIGdldFNpbmdsZUdhbWVMZWFkZXJib2FyZChpbnB1dEV2ZW50KS50aGVuKGZ1bmN0aW9uIHRoZW4obW9kZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsZWFkZXJib2FyZCA9IG1vZGVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgX2xlYWRlcmJvYXJkTGVuZ3RoID0gbGVhZGVyYm9hcmQubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgX3N1bW1hcml6ZWRMZWFkZXJib2FyZCA9IGxlYWRlcmJvYXJkO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIElmIHRoaXMgaXMgYSB0ZWFtLWJhc2VkIGV2ZW50LCBnZXQgdGhlIGRhdGEgbmVlZGVkIGZvciB0ZWFtIGV2ZW50IGNvbXBvbmVudHMuXG4gICAgICAgICAgICAgICAgaWYgKF9ldmVudFByb3BlcnRpZXMuZm9ybWF0LnRlYW1CYXNlZCkge1xuXG4gICAgICAgICAgICAgICAgICAgIHRlYW1TZXJ2aWNlLmdldFRlYW1MaXN0KHZtLmV2ZW50TmFtZSkudGhlbihmdW5jdGlvbiB0aGVuKG1vZGVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBfdGVhbUxpc3QgPSBtb2RlbDtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH1cblxuICAgIH1cbn0pKCk7IiwiKGZ1bmN0aW9uKCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIGFuZ3VsYXJcbiAgICAgICAgLm1vZHVsZSgndmcuYXBwJylcbiAgICAgICAgLmNvbnRyb2xsZXIoJ0V2ZW50TWFpbkNvbnRyb2xsZXInLCBFdmVudE1haW5Db250cm9sbGVyKTtcblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIEV2ZW50TWFpbkNvbnRyb2xsZXIoJHNjb3BlLCAkZmlsdGVyLCAkc3RhdGVQYXJhbXMsICRzdGF0ZSwgJHRpbWVvdXQsICRmaXJlYmFzZUFycmF5LCBldmVudFNlcnZpY2UsIGF1dGhTZXJ2aWNlLCBwcm9maWxlU2VydmljZSwgdGVhbVNlcnZpY2UsIEZJUkVCQVNFREFUQSkge1xuXG4gICAgICAgIC8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi9cbiAgICAgICAgdmFyIHZtID0gdGhpcztcblxuICAgICAgICB2bS5ldmVudE5hbWUgPSAkc3RhdGVQYXJhbXMuZXZlbnROYW1lO1xuXG4gICAgICAgIHZtLmNyZWF0ZVRlYW0gPSBjcmVhdGVUZWFtO1xuICAgICAgICB2bS5kZXRlcm1pbmVQb2ludHMgPSBkZXRlcm1pbmVQb2ludHM7XG4gICAgICAgIHZtLmdvVG9QbGF5ZXJQcm9maWxlID0gZ29Ub1BsYXllclByb2ZpbGU7XG4gICAgICAgIHZtLm9wZW5HYW1lTW9kYWwgPSBvcGVuR2FtZU1vZGFsO1xuICAgICAgICB2bS5vcGVuTW9kYWwgPSBvcGVuTW9kYWw7XG4gICAgICAgIHZtLm9wZW5NdWx0aUdhbWVMZWFkZXJib2FyZE1vZGFsID0gb3Blbk11bHRpR2FtZUxlYWRlcmJvYXJkTW9kYWw7XG4gICAgICAgIHZtLm9wZW5QbGF5ZXJNb2RhbCA9IG9wZW5QbGF5ZXJNb2RhbDtcblxuICAgICAgICBpbml0RXZlbnQoKTtcblxuICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgICAgICBmdW5jdGlvbiBjbG9zZU1vZGFsKCkge1xuICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KCcubW9kYWwnKS5jbG9zZU1vZGFsKCk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBjcmVhdGVUZWFtKCkge1xuICAgICAgICAgICAgdGVhbVNlcnZpY2UuY3JlYXRlVGVhbSh2bS5ldmVudE5hbWUsIHZtLm5ld1RlYW0pLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgTWF0ZXJpYWxpemUudG9hc3QoJ1RlYW0gJyArIHZtLm5ld1RlYW0uc2hvcnROYW1lICsgJyBjcmVhdGVkLicsIDQwMDApO1xuICAgICAgICAgICAgICAgIHZtLm5ld1RlYW0gPSBudWxsO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBkZXRlcm1pbmVQb2ludHMoaW5wdXRTY29yZURhdGEsIGlucHV0SW5kZXgpIHtcblxuICAgICAgICAgICAgdmFyIHVzZXJHYW1lUG9pbnRzO1xuXG4gICAgICAgICAgICAvLyBObyBwb3NpdGlvbiBncmVhdGVyIHRoYW4gMTIgZ2V0cyBwb2ludHMuXG4gICAgICAgICAgICBpZiAoaW5wdXRJbmRleCA+IDExKSB7XG4gICAgICAgICAgICAgICAgdXNlckdhbWVQb2ludHMgPSAwO1xuICAgICAgICAgICAgICAgIHJldHVybiB1c2VyR2FtZVBvaW50cztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdXNlckdhbWVQb2ludHMgPSAxMiAtIGlucHV0SW5kZXg7XG5cbiAgICAgICAgICAgIHZhciBzb3J0ZWRTY29yZXMgPSAkZmlsdGVyKCdvcmRlckJ5Jykodm0uZ2FtZVNjb3JlcywgJy1zY29yZScpO1xuXG4gICAgICAgICAgICAvLyBBbSBJIHRpZWQgd2l0aCB0aGUgcGVyc29uIGFib3ZlIG1lPyBJZiBzbywgbWF0Y2ggdGhlaXIgcG9pbnRzLlxuICAgICAgICAgICAgaWYgKHNvcnRlZFNjb3Jlc1tpbnB1dEluZGV4IC0gMV0pIHtcblxuICAgICAgICAgICAgICAgIGlmIChzb3J0ZWRTY29yZXNbaW5wdXRJbmRleCAtIDFdLnNjb3JlID09PSBpbnB1dFNjb3JlRGF0YS5zY29yZSkge1xuICAgICAgICAgICAgICAgICAgICB1c2VyR2FtZVBvaW50cyArPSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHVzZXJHYW1lUG9pbnRzO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnb1RvUGxheWVyUHJvZmlsZShpbnB1dFBsYXllcikge1xuXG4gICAgICAgICAgICBjbG9zZU1vZGFsKCk7XG4gICAgICAgICAgICAkc3RhdGUuZ28oJ3Byb2ZpbGUnLCB7dXNlcm5hbWU6IGlucHV0UGxheWVyfSk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGluaXRFdmVudCgpIHtcblxuICAgICAgICAgICAgZXZlbnRTZXJ2aWNlLmxvYWRFdmVudFByb3BlcnRpZXModm0uZXZlbnROYW1lKTtcblxuICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0QXZhdGFyRGF0YSgpLnRoZW4oZnVuY3Rpb24gdGhlbihtb2RlbCkge1xuICAgICAgICAgICAgICAgIHZtLmF2YXRhckRhdGEgPSBtb2RlbDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgeyByZXR1cm4gZXZlbnRTZXJ2aWNlLmdldEV2ZW50UHJvcGVydGllc09iamVjdCgpOyB9LCBmdW5jdGlvbihtb2RlbCkge1xuICAgICAgICAgICAgICAgIHZtLmV2ZW50UHJvcGVydGllcyA9IG1vZGVsO1xuICAgICAgICAgICAgfSwgdHJ1ZSk7XG5cbiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7IHJldHVybiBldmVudFNlcnZpY2UuZ2V0VGVhbUxpc3RPYmplY3QoKTsgfSwgZnVuY3Rpb24obW9kZWwpIHtcbiAgICAgICAgICAgICAgICB2bS50ZWFtTGlzdCA9IG1vZGVsO1xuICAgICAgICAgICAgfSwgdHJ1ZSk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIG9wZW5Nb2RhbChpbnB1dE1vZGFsKSB7XG5cbiAgICAgICAgICAgIC8vIFRoaXMgd2lsbCBldmFsdWF0ZSB0byB0cnVlIGlmIGEgTWF0ZXJpYWxpemUgbW9kYWwgaXMgb3Blbi5cbiAgICAgICAgICAgIGlmIChhbmd1bGFyLmVsZW1lbnQoJyNsZWFuLW92ZXJsYXknKS5sZW5ndGggPT09IDEpIHtcblxuICAgICAgICAgICAgICAgIGNsb3NlTW9kYWwoKTtcbiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KGlucHV0TW9kYWwpLm9wZW5Nb2RhbCgpO1xuICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoaW5wdXRNb2RhbCArICdDb250ZW50Jykuc2Nyb2xsVG9wKDApO1xuICAgICAgICAgICAgICAgIH0sIDQ1MCk7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoaW5wdXRNb2RhbCkub3Blbk1vZGFsKCk7XG4gICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KGlucHV0TW9kYWwgKyAnQ29udGVudCcpLnNjcm9sbFRvcCgwKTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBvcGVuR2FtZU1vZGFsKGlucHV0R2FtZU5hbWUpIHtcblxuICAgICAgICAgICAgdmFyIHJlZiA9IG5ldyBGaXJlYmFzZShGSVJFQkFTRURBVEEuRkJVUkwpO1xuXG4gICAgICAgICAgICBldmVudFNlcnZpY2UuZ2V0R2FtZURhdGEodm0uZXZlbnROYW1lLCBpbnB1dEdhbWVOYW1lKS50aGVuKGZ1bmN0aW9uIHRoZW4obW9kZWwpIHtcbiAgICAgICAgICAgICAgICB2bS5nYW1lRGF0YSA9IG1vZGVsO1xuXG4gICAgICAgICAgICAgICAgdm0uZ2FtZVNjb3JlcyA9ICRmaXJlYmFzZUFycmF5KFxuICAgICAgICAgICAgICAgICAgICByZWZcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jaGlsZCgnY29udGVzdHMnKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmNoaWxkKHZtLmV2ZW50TmFtZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jaGlsZCgnYWN0aXZlR2FtZXMnKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmNoaWxkKHZtLmdhbWVEYXRhLiRpZClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jaGlsZCgnc2NvcmVzJylcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG9wZW5Nb2RhbCgnI2dhbWVNb2RhbCcpO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBvcGVuTXVsdGlHYW1lTGVhZGVyYm9hcmRNb2RhbCgpIHtcblxuICAgICAgICAgICAgZXZlbnRTZXJ2aWNlLmdldE11bHRpR2FtZUxlYWRlcmJvYXJkKHZtLmV2ZW50TmFtZSkudGhlbihmdW5jdGlvbiB0aGVuKG1vZGVsKSB7XG4gICAgICAgICAgICAgICAgdm0uY29tcGxldGVMZWFkZXJib2FyZCA9IG1vZGVsO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG9wZW5Nb2RhbCgnI211bHRpR2FtZUxlYWRlcmJvYXJkTW9kYWwnKTtcblxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gb3BlblBsYXllck1vZGFsKGlucHV0UGxheWVyKSB7XG5cbiAgICAgICAgICAgIHZtLmZvY3VzUGxheWVyID0gaW5wdXRQbGF5ZXI7XG5cbiAgICAgICAgICAgIGV2ZW50U2VydmljZS5nZXRQbGF5ZXJTY29yZXModm0uZXZlbnROYW1lLCB2bS5nYW1lTGlzdCwgdm0uZm9jdXNQbGF5ZXIpLnRoZW4oZnVuY3Rpb24gdGhlbihtb2RlbCkge1xuICAgICAgICAgICAgICAgIHZtLnBsYXllclNjb3JlcyA9IG1vZGVsO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG9wZW5Nb2RhbCgnI3BsYXllck1vZGFsJyk7XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG59KSgpOyIsIihmdW5jdGlvbigpIHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICBhbmd1bGFyXG4gICAgICAgIC5tb2R1bGUoJ3ZnLmFwcCcpXG4gICAgICAgIC5zZXJ2aWNlKCd0ZWFtU2VydmljZScsIHRlYW1TZXJ2aWNlKTtcblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIHRlYW1TZXJ2aWNlKCRxLCAkZmlyZWJhc2VBcnJheSwgJGZpcmViYXNlT2JqZWN0LCBGSVJFQkFTRURBVEEpIHtcblxuICAgIFx0dGhpcy5jcmVhdGVUZWFtID0gY3JlYXRlVGVhbTtcbiAgICAgICAgdGhpcy5nZXRUZWFtTGlzdCA9IGdldFRlYW1MaXN0O1xuXG4gICAgICAgIC8vLy8vLy8vLy8vLy8vLy9cblxuICAgICAgICBmdW5jdGlvbiBjcmVhdGVUZWFtKGlucHV0RXZlbnQsIGlucHV0TmV3VGVhbVByb3BlcnRpZXMpIHtcblxuICAgICAgICBcdHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG5cbiAgICAgICAgXHR2YXIgcmVmID0gbmV3IEZpcmViYXNlKEZJUkVCQVNFREFUQS5GQlVSTCk7XG4gICAgICAgIFx0dmFyIHRlYW1Qb29sID0gJGZpcmViYXNlT2JqZWN0KFxuICAgICAgICBcdFx0cmVmXG4gICAgICAgIFx0XHRcdC5jaGlsZCgnY29udGVzdHMnKVxuICAgICAgICBcdFx0XHQuY2hpbGQoaW5wdXRFdmVudClcbiAgICAgICAgXHRcdFx0LmNoaWxkKCd0ZWFtUG9vbCcpXG4gICAgICAgIFx0KTtcblxuICAgICAgICBcdHRlYW1Qb29sLiRsb2FkZWQoKS50aGVuKGZ1bmN0aW9uKCkge1xuXG4gICAgICAgIFx0XHR0ZWFtUG9vbFtpbnB1dE5ld1RlYW1Qcm9wZXJ0aWVzLnNob3J0TmFtZV0gPSB7XG4gICAgICAgIFx0XHRcdGZ1bGxOYW1lOiBpbnB1dE5ld1RlYW1Qcm9wZXJ0aWVzLmZvcm1hbE5hbWVcbiAgICAgICAgXHRcdH07XG4gICAgICAgIFx0XHR0ZWFtUG9vbC4kc2F2ZSgpO1xuICAgICAgICBcdFx0ZGVmZXJyZWQucmVzb2x2ZSgpO1xuXG4gICAgICAgIFx0fSk7XG5cbiAgICAgICAgXHRyZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcblxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZ2V0VGVhbUxpc3QoaW5wdXRFdmVudCkge1xuXG4gICAgICAgIFx0dmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcblxuICAgICAgICBcdHZhciByZWYgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKTtcbiAgICAgICAgXHR2YXIgdGVhbUxpc3QgPSAkZmlyZWJhc2VBcnJheShcbiAgICAgICAgXHRcdHJlZlxuICAgICAgICBcdFx0XHQuY2hpbGQoJ2NvbnRlc3RzJylcbiAgICAgICAgXHRcdFx0LmNoaWxkKGlucHV0RXZlbnQpXG4gICAgICAgIFx0XHRcdC5jaGlsZCgndGVhbVBvb2wnKVxuICAgICAgICBcdCk7XG5cbiAgICAgICAgXHR0ZWFtTGlzdC4kbG9hZGVkKCkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgXHRcdGRlZmVycmVkLnJlc29sdmUodGVhbUxpc3QpO1xuICAgICAgICBcdH0pO1xuXG4gICAgICAgIFx0cmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG5cbiAgICAgICAgfVxuICAgIH1cbn0pKCk7IiwiKGZ1bmN0aW9uKCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIGFuZ3VsYXJcbiAgICAgICAgLm1vZHVsZSgndmcuYXBwJylcbiAgICAgICAgLmZpbHRlcignb3JkZXJPYmplY3RCeScsIG9yZGVyT2JqZWN0QnkpO1xuXG4gICAgZnVuY3Rpb24gb3JkZXJPYmplY3RCeSgpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGl0ZW1zLCBmaWVsZCwgcmV2ZXJzZSkge1xuICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107XG5cbiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChpdGVtcywgZnVuY3Rpb24oaXRlbSwga2V5KSB7XG4gICAgICAgICAgICAgICAgaXRlbS5rZXkgPSBrZXk7XG4gICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaChpdGVtKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBmaWx0ZXJlZC5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChhW2ZpZWxkXSA+IGJbZmllbGRdID8gMSA6IC0xKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZihyZXZlcnNlKSBmaWx0ZXJlZC5yZXZlcnNlKCk7XG5cbiAgICAgICAgICAgIHJldHVybiBmaWx0ZXJlZDtcbiAgICAgICAgfTtcbiAgICB9XG5cbn0pKCk7IiwiKGZ1bmN0aW9uKCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIGFuZ3VsYXJcbiAgICAgICAgLm1vZHVsZSgndmcuYXBwJylcbiAgICAgICAgLmNvbnRyb2xsZXIoJ0hlYWRlckNvbnRyb2xsZXInLCBIZWFkZXJDb250cm9sbGVyKTtcblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIEhlYWRlckNvbnRyb2xsZXIoJHRpbWVvdXQsICRyb290U2NvcGUsICR3aW5kb3csICRzdGF0ZSwgYXV0aFNlcnZpY2UpIHtcblxuICAgICAgICAvKiBqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovXG4gICAgICAgIHZhciB2bSA9IHRoaXM7XG4gICAgICAgIHZtLmxvZ091dCA9IGxvZ091dDtcblxuICAgICAgICBhY3RpdmF0ZSgpO1xuXG4gICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAgICAgZnVuY3Rpb24gYWN0aXZhdGUoKSB7XG4gICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoJy5kcm9wZG93bi1idXR0b24nKVxuICAgICAgICAgICAgICAgICAgICAuZHJvcGRvd24oe1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5EdXJhdGlvbjogMzAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0RHVyYXRpb246IDIyNSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0cmFpbl93aWR0aDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBob3ZlcjogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBndXR0ZXI6IC0xMTQsXG4gICAgICAgICAgICAgICAgICAgICAgICBiZWxvd09yaWdpbjogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0sIDQwMCk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBsb2dPdXQoKSB7XG4gICAgICAgICAgICBhdXRoU2VydmljZS5sb2dPdXQoKTtcbiAgICAgICAgICAgICR3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XG4gICAgICAgIH1cblxuICAgIH1cbn0pKCk7IiwiKGZ1bmN0aW9uKCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIGFuZ3VsYXJcbiAgICAgICAgLm1vZHVsZSgndmcuYXBwJylcbiAgICAgICAgLmNvbnRyb2xsZXIoJ0F2YXRhckNvbnRyb2xsZXInLCBBdmF0YXJDb250cm9sbGVyKTtcblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIEF2YXRhckNvbnRyb2xsZXIoJHJvb3RTY29wZSwgJHN0YXRlLCAkc3RhdGVQYXJhbXMsICR0aW1lb3V0LCBVcGxvYWQsIGltZ3VyLCBwcm9maWxlU2VydmljZSkge1xuXG4gICAgICAgIC8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi9cbiAgICAgICAgdmFyIHZtID0gdGhpcztcbiAgICAgICAgdm0udXBsb2FkQXZhdGFyID0gdXBsb2FkQXZhdGFyO1xuXG4gICAgICAgIGFjdGl2YXRlKCk7XG5cbiAgICAgICAgLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgICAgIGZ1bmN0aW9uIGFjdGl2YXRlKCkge1xuICAgICAgICBcdHByb2ZpbGVTZXJ2aWNlLmdldEF2YXRhckRhdGEoKS50aGVuKGZ1bmN0aW9uIHRoZW4obW9kZWwpIHtcbiAgICAgICAgICAgICAgICB2bS5hdmF0YXJEYXRhID0gbW9kZWw7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgLy8gRklYTUU6IFRoaXMgbmVlZHMgdG8gYmUgdHJpZ2dlcmVkIGJ5IGEgJHJvb3RTY29wZSBicm9hZGNhc3Qgb2Ygd2hlbiBpdCByZWNlaXZlcyBwcm9maWxlIGRhdGEuXG4gICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBwcm9maWxlU2VydmljZS5nZXRCYWRnZXNEYXRhKCRyb290U2NvcGUucHJvZmlsZS51c2VyTmFtZSkudGhlbihmdW5jdGlvbiB0aGVuKG1vZGVsKSB7XG4gICAgICAgICAgICAgICAgICAgIHZtLmJhZGdlc0RhdGEgPSBtb2RlbDtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0sIDUwMCk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiB1cGxvYWRBdmF0YXIoKSB7XG5cbiAgICAgICAgXHR2bS5kaXNhYmxlQnV0dG9uID0gdHJ1ZTtcblxuICAgICAgICBcdGltZ3VyLnNldEFQSUtleSgnQ2xpZW50LUlEIGY1M2Q2ZDU4MzNiMDdiYycpO1xuICAgICAgICBcdGltZ3VyLnVwbG9hZCh2bS5maWxlKS50aGVuKGZ1bmN0aW9uIHRoZW4obW9kZWwpIHtcbiAgICAgICAgXHRcdHByb2ZpbGVTZXJ2aWNlLnNhdmVBdmF0YXJMaW5rKG1vZGVsWzBdLmxpbmssICRyb290U2NvcGUucHJvZmlsZS51c2VyTmFtZSk7XG4gICAgICAgIFx0XHRNYXRlcmlhbGl6ZS50b2FzdCgnWW91ciBhdmF0YXIgd2FzIHVwbG9hZGVkJywgNDAwMCk7XG5cbiAgICAgICAgXHRcdCR0aW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICBcdFx0XHQkc3RhdGUuZ28oJ2hvbWUnKTtcbiAgICAgICAgXHRcdH0sIDEwMDApO1xuICAgICAgICBcdH0pO1xuXG4gICAgICAgIH1cblxuICAgIH1cbn0pKCk7IiwiKGZ1bmN0aW9uKCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIGFuZ3VsYXJcbiAgICAgICAgLm1vZHVsZSgndmcuYXBwJylcbiAgICAgICAgLmNvbnRyb2xsZXIoJ0NoYW5nZVBhc3N3b3JkQ29udHJvbGxlcicsIENoYW5nZVBhc3N3b3JkQ29udHJvbGxlcik7XG5cbiAgICAvKiBAbmdJbmplY3QgKi9cbiAgICBmdW5jdGlvbiBDaGFuZ2VQYXNzd29yZENvbnRyb2xsZXIoJHNjb3BlLCAkdGltZW91dCwgJHN0YXRlLCBBdXRoV3JhcHBlcikge1xuXG4gICAgICAgIC8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi9cbiAgICAgICAgdmFyIHZtID0gdGhpcztcbiAgICAgICAgXG4gICAgICAgIHZtLnN1Ym1pdENoYW5nZVBhc3N3b3JkID0gc3VibWl0Q2hhbmdlUGFzc3dvcmQ7XG5cbiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAgICAgZnVuY3Rpb24gc3VibWl0Q2hhbmdlUGFzc3dvcmQoKSB7XG5cbiAgICAgICAgICAgIGlmICgkc2NvcGUucHdDaGFuZ2VGb3JtLiR2YWxpZCkge1xuXG4gICAgICAgICAgICAgICAgQXV0aFdyYXBwZXIuJGNoYW5nZVBhc3N3b3JkKHtcbiAgICAgICAgICAgICAgICAgICAgZW1haWw6IEF1dGhXcmFwcGVyLiRnZXRBdXRoKCkucGFzc3dvcmQuZW1haWwsXG4gICAgICAgICAgICAgICAgICAgIG9sZFBhc3N3b3JkOiB2bS5pbnB1dEN1cnJlbnRQYXNzd29yZCxcbiAgICAgICAgICAgICAgICAgICAgbmV3UGFzc3dvcmQ6IHZtLmlucHV0TmV3UGFzc3dvcmRcbiAgICAgICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICAgICAgICAgIE1hdGVyaWFsaXplLnRvYXN0KCdZb3VyIHBhc3N3b3JkIHdhcyBjaGFuZ2VkLicsIDQwMDApO1xuICAgICAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0ZS5nbygnaG9tZScpO1xuICAgICAgICAgICAgICAgICAgICB9LCAxMDAwKTtcblxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ0lOVkFMSURfUEFTU1dPUkQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2bS5zaG93Q2hhbmdlUGFzc3dvcmRNZXNzYWdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICB9XG5cbn0pKCk7IiwiKGZ1bmN0aW9uKCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIGFuZ3VsYXJcbiAgICAgICAgLm1vZHVsZSgndmcuYXBwJylcbiAgICAgICAgLmNvbnRyb2xsZXIoJ0hvbWVDb250cm9sbGVyJywgSG9tZUNvbnRyb2xsZXIpO1xuXG4gICAgLyogQG5nSW5qZWN0ICovXG4gICAgZnVuY3Rpb24gSG9tZUNvbnRyb2xsZXIoJHNjb3BlLCAkdGltZW91dCkge1xuXG4gICAgICAgIC8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi9cbiAgICAgICAgdmFyIHZtID0gdGhpcztcblxuICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIH1cblxufSkoKTsiLCIoZnVuY3Rpb24oKSB7XG4gICAgJ3VzZSBzdHJpY3QnO1xuXG4gICAgYW5ndWxhclxuICAgICAgICAubW9kdWxlKCd2Zy5hcHAnKVxuICAgICAgICAuY29udHJvbGxlcignTGVhZGVyYm9hcmRDb250cm9sbGVyJywgTGVhZGVyYm9hcmRDb250cm9sbGVyKTtcblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIExlYWRlcmJvYXJkQ29udHJvbGxlcigkcSwgJHRpbWVvdXQsICRmaXJlYmFzZUFycmF5LCBwcm9maWxlU2VydmljZSwgRklSRUJBU0VEQVRBKSB7XG5cbiAgICAgICAgLyoganNoaW50IHZhbGlkdGhpczogdHJ1ZSAqL1xuICAgIFx0dmFyIHZtID0gdGhpcztcblxuICAgICAgICBhY3RpdmF0ZSgpO1xuXG4gICAgICAgIC8vLy8vLy8vLy8vLy8vLy9cblxuICAgICAgICBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgICAgICAgICAgIGdldFByb2ZpbGVTY29yZXMoKS50aGVuKGZ1bmN0aW9uIHRoZW4obW9kZWwpIHtcbiAgICAgICAgICAgICAgICB2bS5wcm9maWxlU2NvcmVEYXRhID0gbW9kZWw7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0QXZhdGFyRGF0YSgpLnRoZW4oZnVuY3Rpb24gdGhlbihtb2RlbCkge1xuICAgICAgICAgICAgICAgIHZtLmF2YXRhckRhdGEgPSBtb2RlbDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZ2V0UHJvZmlsZVNjb3JlcygpIHtcblxuICAgICAgICBcdHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG4gICAgICAgIFx0dmFyIHJlZiA9IG5ldyBGaXJlYmFzZShGSVJFQkFTRURBVEEuRkJVUkwpO1xuXG4gICAgICAgIFx0dmFyIHByb2ZpbGVTY29yZURhdGEgPSAkZmlyZWJhc2VBcnJheShcbiAgICAgICAgXHRcdHJlZlxuICAgICAgICBcdFx0XHQuY2hpbGQoJ2JhZGdlcycpXG4gICAgICAgIFx0KTtcblxuICAgICAgICBcdHByb2ZpbGVTY29yZURhdGEuJGxvYWRlZChmdW5jdGlvbigpIHtcbiAgICAgICAgXHRcdGRlZmVycmVkLnJlc29sdmUocHJvZmlsZVNjb3JlRGF0YSk7XG4gICAgICAgIFx0fSk7XG5cbiAgICAgICAgXHRyZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcblxuICAgICAgICB9XG5cbiAgICB9XG59KSgpOyIsIihmdW5jdGlvbigpIHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICBhbmd1bGFyXG4gICAgICAgIC5tb2R1bGUoJ3ZnLmFwcCcpXG4gICAgICAgIC5jb250cm9sbGVyKCdQcm9maWxlQ29udHJvbGxlcicsIFByb2ZpbGVDb250cm9sbGVyKTtcblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIFByb2ZpbGVDb250cm9sbGVyKCRzY29wZSwgJHN0YXRlUGFyYW1zLCAkcSwgJHRpbWVvdXQsICRzdGF0ZSwgJGZpcmViYXNlQXJyYXksIGF1dGhTZXJ2aWNlLCBwcm9maWxlU2VydmljZSwgZXZlbnRTZXJ2aWNlKSB7XG5cbiAgICAgICAgLyoganNoaW50IHZhbGlkdGhpczogdHJ1ZSAqL1xuICAgICAgICB2YXIgdm0gPSB0aGlzO1xuICAgICAgICBcbiAgICAgICAgYWN0aXZhdGUoKTtcblxuICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgICAgICBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcblxuICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0VXNlckRhdGEoJHN0YXRlUGFyYW1zLnVzZXJuYW1lKS50aGVuKGZ1bmN0aW9uIHRoZW4obW9kZWwpIHtcbiAgICAgICAgICAgICAgICB2bS5wcm9maWxlRGF0YSA9IG1vZGVsO1xuXG4gICAgICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0VG91cm5hbWVudEhpc3Rvcnkodm0ucHJvZmlsZURhdGEpLnRoZW4oZnVuY3Rpb24gdGhlbihtb2RlbCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdG91cm5hbWVudEhpc3RvcnlEYXRhID0gbW9kZWw7XG4gICAgICAgICAgICAgICAgICAgIHZtLmV2ZW50U3RhbmRpbmdzID0gcHJvZmlsZVNlcnZpY2UuZ2V0VG91cm5hbWVudFN0YW5kaW5ncyh0b3VybmFtZW50SGlzdG9yeURhdGEsICRzdGF0ZVBhcmFtcy51c2VybmFtZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcHJvZmlsZVNlcnZpY2UuZ2V0QXZhdGFyRGF0YSgpLnRoZW4oZnVuY3Rpb24gdGhlbihtb2RlbCkge1xuICAgICAgICAgICAgICAgIHZtLmF2YXRhckRhdGEgPSBtb2RlbDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBwcm9maWxlU2VydmljZS5nZXRCYWRnZXNEYXRhKCRzdGF0ZVBhcmFtcy51c2VybmFtZSkudGhlbihmdW5jdGlvbiB0aGVuKG1vZGVsKSB7XG4gICAgICAgICAgICAgICAgdm0uYmFkZ2VzRGF0YSA9IG1vZGVsO1xuXG4gICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KCcuY29sbGFwc2libGUnKS5jb2xsYXBzaWJsZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY2NvcmRpb246IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB9LCAyMDApO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG59KSgpOyIsIihmdW5jdGlvbigpIHtcbiAgICAndXNlIHN0cmljdCc7XG5cbiAgICBhbmd1bGFyXG4gICAgICAgIC5tb2R1bGUoJ3ZnLmFwcCcpXG4gICAgICAgIC5zZXJ2aWNlKCdwcm9maWxlU2VydmljZScsIHByb2ZpbGVTZXJ2aWNlKTtcblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIHByb2ZpbGVTZXJ2aWNlKCRyb290U2NvcGUsICRxLCAkZmlyZWJhc2VBcnJheSwgJGZpcmViYXNlT2JqZWN0LCBldmVudFNlcnZpY2UsIEZJUkVCQVNFREFUQSkge1xuXG4gICAgXHR0aGlzLmdldEF2YXRhckRhdGEgPSBnZXRBdmF0YXJEYXRhO1xuICAgICAgICB0aGlzLmdldEJhZGdlc0RhdGEgPSBnZXRCYWRnZXNEYXRhO1xuICAgIFx0dGhpcy5nZXRUb3VybmFtZW50SGlzdG9yeSA9IGdldFRvdXJuYW1lbnRIaXN0b3J5O1xuICAgICAgICB0aGlzLmdldFRvdXJuYW1lbnRTdGFuZGluZ3MgPSBnZXRUb3VybmFtZW50U3RhbmRpbmdzO1xuICAgICAgICB0aGlzLmdldFVzZXJEYXRhID0gZ2V0VXNlckRhdGE7XG4gICAgICAgIHRoaXMuc2F2ZUF2YXRhckxpbmsgPSBzYXZlQXZhdGFyTGluaztcblxuICAgICAgICAvLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAgICAgZnVuY3Rpb24gZ2V0QXZhdGFyRGF0YSgpIHtcblxuICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcbiAgICAgICAgICAgIHZhciByZWYgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKTtcblxuICAgICAgICAgICAgdmFyIGF2YXRhckRhdGEgPSAkZmlyZWJhc2VPYmplY3QoXG4gICAgICAgICAgICAgICAgcmVmXG4gICAgICAgICAgICAgICAgICAgIC5jaGlsZCgnYXZhdGFycycpXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBhdmF0YXJEYXRhLiRsb2FkZWQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShhdmF0YXJEYXRhKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcblxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZ2V0QmFkZ2VzRGF0YShpbnB1dFVzZXIpIHtcblxuICAgICAgICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcbiAgICAgICAgICAgIHZhciByZWYgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKTtcblxuICAgICAgICAgICAgdmFyIGJhZGdlc0RhdGEgPSAkZmlyZWJhc2VPYmplY3QoXG4gICAgICAgICAgICAgICAgcmVmXG4gICAgICAgICAgICAgICAgICAgIC5jaGlsZCgnYmFkZ2VzJylcbiAgICAgICAgICAgICAgICAgICAgLmNoaWxkKGlucHV0VXNlcilcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGJhZGdlc0RhdGEuJGxvYWRlZChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGJhZGdlc0RhdGEpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXRUb3VybmFtZW50SGlzdG9yeShpbnB1dFVzZXJEYXRhKSB7XG5cbiAgICAgICAgXHR2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpO1xuICAgICAgICBcdHZhciByZWYgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKTtcblxuICAgICAgICBcdC8vIExvb3AgdGhyb3VnaCBlYWNoIGV2ZW50IGluIHRoZSBwbGVkZ2VkVG8gb2JqZWN0LlxuICAgICAgICBcdHZhciBldmVudHNBcnJheSA9IFtdO1xuICAgICAgICBcdGZvciAodmFyIGtleSBpbiBpbnB1dFVzZXJEYXRhLnBsZWRnZWRUbykge1xuICAgICAgICBcdFx0ZXZlbnRzQXJyYXkucHVzaChrZXkpO1xuICAgICAgICBcdH1cblxuICAgICAgICBcdGRlZmVycmVkLnJlc29sdmUoZXZlbnRzQXJyYXkpO1xuXG4gICAgICAgIFx0cmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGdldFRvdXJuYW1lbnRTdGFuZGluZ3MoaW5wdXRUb3VybmFtZW50SGlzdG9yeSwgaW5wdXRVc2VyKSB7XG5cbiAgICAgICAgICAgIHZhciByZWYgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKTtcblxuICAgICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGVhY2ggZXZlbnQgaW4gdGhlIHVzZXIncyBoaXN0b3J5LlxuICAgICAgICAgICAgdmFyIGV2ZW50U3RhbmRpbmdzID0gW107XG4gICAgICAgICAgICBpbnB1dFRvdXJuYW1lbnRIaXN0b3J5LmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHtcblxuICAgICAgICAgICAgICAgIGV2ZW50U2VydmljZS5nZXRFdmVudFByb3BlcnRpZXMoZXZlbnQpLnRoZW4oZnVuY3Rpb24oZXZlbnRQcm9wZXJ0aWVzKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgZXZlbnRQcm9wZXJ0aWVzLiRsb2FkZWQoKS50aGVuKGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBjb25jbHVkZWQsIGdldCB0aGUgdXNlcidzIHN0YW5kaW5nLlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50UHJvcGVydGllcy5zdGF0ZSA9PT0gJ2NvbmNsdWRlZCcpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudFN0YW5kaW5nRGF0YSA9ICRmaXJlYmFzZU9iamVjdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2hpbGQoJ3N0YW5kaW5ncycpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2hpbGQoZXZlbnQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50U3RhbmRpbmdEYXRhLiRsb2FkZWQoKS50aGVuKGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudFN0YW5kaW5nRGF0YVtpbnB1dFVzZXJdKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50U3RhbmRpbmdzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGV2ZW50UHJvcGVydGllcy5uYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZW1pZXI6IGV2ZW50UHJvcGVydGllcy5wcmVtaWVyID8gdHJ1ZSA6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvcnROYW1lOiBldmVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZTogJ2NvbmNsdWRlZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IGV2ZW50UHJvcGVydGllcy5jb2xvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogZXZlbnRTdGFuZGluZ0RhdGFbaW5wdXRVc2VyXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRTdGFuZGluZ3MucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogZXZlbnRQcm9wZXJ0aWVzLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlbWllcjogZXZlbnRQcm9wZXJ0aWVzLnByZW1pZXIgPyB0cnVlIDogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG9ydE5hbWU6IGV2ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlOiAnY29uY2x1ZGVkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogZXZlbnRQcm9wZXJ0aWVzLmNvbG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAtMVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnRQcm9wZXJ0aWVzLnN0YXRlID09PSAnaW5wcm9ncmVzcycgfHwgZXZlbnRQcm9wZXJ0aWVzLnN0YXRlID09PSAndXBjb21pbmcnKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudFN0YW5kaW5ncy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogZXZlbnRQcm9wZXJ0aWVzLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZW1pZXI6IGV2ZW50UHJvcGVydGllcy5wcmVtaWVyID8gdHJ1ZSA6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3J0TmFtZTogZXZlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBldmVudFByb3BlcnRpZXMuY29sb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlOiBldmVudFByb3BlcnRpZXMuc3RhdGVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gZXZlbnRTdGFuZGluZ3M7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGdldFVzZXJEYXRhKGlucHV0VXNlcikge1xuXG4gICAgICAgIFx0dmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcbiAgICAgICAgXHR2YXIgcmVmID0gbmV3IEZpcmViYXNlKEZJUkVCQVNFREFUQS5GQlVSTCk7XG5cbiAgICAgICAgXHR2YXIgdXNlcnNEYXRhID0gJGZpcmViYXNlQXJyYXkoXG4gICAgICAgIFx0XHRyZWZcbiAgICAgICAgXHRcdFx0LmNoaWxkKCd1c2VycycpXG4gICAgICAgIFx0KTtcblxuICAgICAgICBcdHVzZXJzRGF0YS4kbG9hZGVkKGZ1bmN0aW9uKCkge1xuXG4gICAgICAgIFx0XHR1c2Vyc0RhdGEuZm9yRWFjaChmdW5jdGlvbih1c2VyKSB7XG4gICAgICAgIFx0XHRcdGlmICh1c2VyLnVzZXJOYW1lID09PSBpbnB1dFVzZXIpIHtcbiAgICAgICAgXHRcdFx0XHRkZWZlcnJlZC5yZXNvbHZlKHVzZXIpO1xuICAgICAgICBcdFx0XHR9XG4gICAgICAgIFx0XHR9KTtcblxuICAgICAgICBcdH0pO1xuXG4gICAgICAgIFx0cmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEZJWE1FOiBNYWtlIHRoaXMgc2VydmVyLXNpZGUuXG4gICAgICAgIGZ1bmN0aW9uIHNhdmVBdmF0YXJMaW5rKGlucHV0TGluaywgaW5wdXRVc2VyKSB7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHZhciByZWYgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VEQVRBLkZCVVJMKTtcblxuICAgICAgICAgICAgdmFyIGF2YXRhckRhdGEgPSAkZmlyZWJhc2VPYmplY3QoXG4gICAgICAgICAgICAgICAgcmVmXG4gICAgICAgICAgICAgICAgICAgIC5jaGlsZCgnYXZhdGFycycpXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBhdmF0YXJEYXRhLiRsb2FkZWQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgYXZhdGFyRGF0YVtpbnB1dFVzZXJdID0gaW5wdXRMaW5rO1xuICAgICAgICAgICAgICAgIGF2YXRhckRhdGEuJHNhdmUoKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH1cblxuICAgIH1cbn0pKCk7IiwiKGZ1bmN0aW9uKCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIGFuZ3VsYXJcbiAgICAgICAgLm1vZHVsZSgndmcuYXBwJylcbiAgICAgICAgLmNvbnRyb2xsZXIoJ1JlZ0NvbnRyb2xsZXInLCBSZWdDb250cm9sbGVyKTtcblxuICAgIC8qIEBuZ0luamVjdCAqL1xuICAgIGZ1bmN0aW9uIFJlZ0NvbnRyb2xsZXIoJHNjb3BlLCAkcm9vdFNjb3BlLCAkdGltZW91dCwgJHdpbmRvdywgJHN0YXRlLCAkZmlyZWJhc2VPYmplY3QsIGF1dGhTZXJ2aWNlLCBBdXRoV3JhcHBlcikge1xuXG4gICAgICAgIC8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi9cbiAgICAgICAgdmFyIHZtID0gdGhpcztcblxuICAgICAgICB2bS5sb2dpblRvQWNjb3VudCA9IGxvZ2luVG9BY2NvdW50O1xuICAgICAgICB2bS5wYXNzd29yZFJlc2V0ID0gcGFzc3dvcmRSZXNldDtcbiAgICAgICAgdm0uc3VibWl0TmV3QWNjb3VudCA9IHN1Ym1pdE5ld0FjY291bnQ7XG5cbiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICAgICAgZnVuY3Rpb24gbG9naW5Ub0FjY291bnQoKSB7XG5cbiAgICAgICAgICAgIGF1dGhTZXJ2aWNlLmxvZ2luVG9BY2NvdW50KHZtLmxvZ2luRW1haWwsIHZtLmxvZ2luUGFzc3dvcmQpLnRoZW4oZnVuY3Rpb24gdGhlbihtb2RlbCkge1xuXG4gICAgICAgICAgICAgICAgdm0uc2hvd0ludmFsaWRVc2VyRXJyb3IgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2bS5zaG93SW52YWxpZFBhc3N3b3JkRXJyb3IgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAgIGlmIChtb2RlbCA9PT0gJ0xPR0lOX1NVQ0NFU1MnKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgJHN0YXRlLmdvKCdob21lJyk7XG5cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1vZGVsID09PSAnSU5WQUxJRF9VU0VSJykge1xuICAgICAgICAgICAgICAgICAgICB2bS5zaG93SW52YWxpZFVzZXJFcnJvciA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1vZGVsID09PSAnSU5WQUxJRF9QQVNTV09SRCcpIHtcbiAgICAgICAgICAgICAgICAgICAgdm0uc2hvd0ludmFsaWRQYXNzd29yZEVycm9yID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBwYXNzd29yZFJlc2V0KCkge1xuXG4gICAgICAgICAgICBpZiAoIXZtLmxvZ2luRW1haWwpIHtcbiAgICAgICAgICAgICAgICB2bS5zaG93UGFzc3dvcmRSZXNldEVtYWlsTWVzc2FnZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBBdXRoV3JhcHBlci4kcmVzZXRQYXNzd29yZCh7XG4gICAgICAgICAgICAgICAgZW1haWw6IHZtLmxvZ2luRW1haWxcbiAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgdm0uc2hvd1Bhc3N3b3JkUmVzZXRFbWFpbE1lc3NhZ2UgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBNYXRlcmlhbGl6ZS50b2FzdCgnQSBwYXNzd29yZCByZXNldCBlbWFpbCBoYXMgYmVlbiBzZW50IHRvICcgKyB2bS5sb2dpbkVtYWlsICsgJy4nLCA0MDAwKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBzdWJtaXROZXdBY2NvdW50KCkge1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBEb2VzIHRoZSB1c2VyIGV4aXN0PyBJZiBzbywgc2hvdyBhbiBlcnJvciBtZXNzYWdlLlxuICAgICAgICAgICAgYXV0aFNlcnZpY2UuY2hlY2tJZlVzZXJFeGlzdHModm0ubmV3VXNlcm5hbWUpLnRoZW4oZnVuY3Rpb24odXNlckV4aXN0cykge1xuXG4gICAgICAgICAgICAgICAgdm0uc2hvd0R1cGxpY2F0ZVVzZXJFcnJvciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZtLnNob3dFbWFpbFRha2VuRXJyb3IgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAgIGlmICh1c2VyRXhpc3RzKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgdm0uc2hvd0R1cGxpY2F0ZVVzZXJFcnJvciA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgICAgIC8vIFRyeSB0byBjcmVhdGUgdGhlIG5ldyB1c2VyLlxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICAgICAgYXV0aFNlcnZpY2UuY3JlYXRlTmV3VXNlcih2bS5uZXdFbWFpbCwgdm0ubmV3UGFzc3dvcmQsIHZtLm5ld1VzZXJuYW1lKS50aGVuKGZ1bmN0aW9uIHRoZW4obW9kZWwpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGVsID09PSAnRU1BSUxfVEFLRU4nKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bS5zaG93RW1haWxUYWtlbkVycm9yID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobW9kZWwgPT09ICdBQ0NPVU5UX0NSRUFURUQnKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdGUuZ28oJ3Byb2ZpbGUnLCB7dXNlcm5hbWU6IHZtLm5ld1VzZXJuYW1lfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG59KSgpOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==